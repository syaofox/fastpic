{% extends "base.html" %}
{% block title %}设置 - FastPic{% endblock %}
{% block content %}
<div class="min-h-screen bg-slate-50">
    <!-- 顶部栏 -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center gap-4">
        <a href="/" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors" title="返回首页">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        </a>
        <h1 class="text-lg font-semibold text-slate-800">设置</h1>
    </header>

    <div class="max-w-4xl mx-auto px-6 py-6">
        <!-- 标签页导航 -->
        <div class="flex border-b border-slate-200 mb-6" id="settings-tabs">
            <button type="button" data-tab="maintenance"
                    class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors -mb-px border-blue-500 text-blue-600"
                    onclick="switchTab('maintenance')">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    数据维护
                </span>
            </button>
            <button type="button" data-tab="duplicates"
                    class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors -mb-px border-transparent text-slate-500 hover:text-slate-700"
                    onclick="switchTab('duplicates')">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    重复文件
                </span>
            </button>
            <button type="button" data-tab="tags"
                    class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors -mb-px border-transparent text-slate-500 hover:text-slate-700"
                    onclick="switchTab('tags')">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                    标签管理
                </span>
            </button>
            <button type="button" data-tab="about"
                    class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors -mb-px border-transparent text-slate-500 hover:text-slate-700"
                    onclick="switchTab('about')">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    关于
                </span>
            </button>
        </div>

        <!-- 标签页内容 -->
        <!-- ======== 数据维护 ======== -->
        <div id="tab-maintenance" class="tab-content">
            <!-- 统计概览 -->
            <div class="bg-white rounded-xl border border-slate-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base font-semibold text-slate-800">数据概览</h2>
                    <button type="button" onclick="loadStats()" class="text-sm text-blue-600 hover:text-blue-700 font-medium transition-colors">刷新</button>
                </div>
                <div id="stats-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-slate-800" id="stat-images">-</div>
                        <div class="text-xs text-slate-500 mt-1">图片总数</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-slate-800" id="stat-folders">-</div>
                        <div class="text-xs text-slate-500 mt-1">文件夹数</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-slate-800" id="stat-size">-</div>
                        <div class="text-xs text-slate-500 mt-1">图片总大小</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-slate-800" id="stat-cache">-</div>
                        <div class="text-xs text-slate-500 mt-1">缓存大小</div>
                    </div>
                </div>
                <div class="mt-4 text-xs text-slate-400 space-y-1" id="stats-paths"></div>
            </div>

            <!-- 操作区 -->
            <div class="space-y-4">
                <!-- 扫描新图片 -->
                <div class="bg-white rounded-xl border border-slate-200 p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-semibold text-slate-800 mb-1">扫描新图片</h3>
                            <p class="text-sm text-slate-500 mb-3">扫描 photos 目录中尚未入库的图片，自动生成缩略图并写入数据库。适用于手动拷贝图片到目录后的场景。</p>
                            <div class="flex items-center gap-3">
                                <button type="button" id="scan-btn" onclick="triggerScan()"
                                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    开始扫描
                                </button>
                                <span id="scan-status" class="text-sm text-slate-500"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 清理同步 -->
                <div class="bg-white rounded-xl border border-slate-200 p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-semibold text-slate-800 mb-1">清理同步</h3>
                            <p class="text-sm text-slate-500 mb-3">将数据库与文件系统同步，处理以下不一致问题：</p>
                            <ul class="text-sm text-slate-500 mb-3 ml-4 list-disc space-y-1">
                                <li><span class="text-slate-700 font-medium">幽灵记录</span>：原图已被外部删除，清理数据库记录和对应缓存</li>
                                <li><span class="text-slate-700 font-medium">孤儿缓存</span>：缓存目录中无对应数据库记录的多余文件</li>
                                <li><span class="text-slate-700 font-medium">缺失缓存</span>：数据库有记录但缩略图丢失，重新生成</li>
                            </ul>
                            <div class="flex items-center gap-3">
                                <button type="button" id="cleanup-btn" onclick="triggerCleanup()"
                                        class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    开始清理
                                </button>
                                <span id="cleanup-status" class="text-sm text-slate-500"></span>
                            </div>
                            <div id="cleanup-result" class="hidden mt-3 p-3 bg-slate-50 rounded-lg text-sm text-slate-600 space-y-1"></div>
                        </div>
                    </div>
                </div>

                <!-- 完整重建 -->
                <div class="bg-white rounded-xl border border-slate-200 p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-semibold text-slate-800 mb-1">完整重建</h3>
                            <p class="text-sm text-slate-500 mb-3">先执行清理同步，再执行全量扫描。适用于数据严重不一致、首次部署或迁移后的场景。耗时较长。</p>
                            <div class="flex items-center gap-3">
                                <button type="button" id="rebuild-btn" onclick="triggerRebuild()"
                                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    完整重建
                                </button>
                                <span id="rebuild-status" class="text-sm text-slate-500"></span>
                            </div>
                            <div id="rebuild-result" class="hidden mt-3 p-3 bg-slate-50 rounded-lg text-sm text-slate-600 space-y-1"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ======== 重复文件 ======== -->
        <div id="tab-duplicates" class="tab-content hidden">
            <div class="bg-white rounded-xl border border-slate-200 p-6">
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg bg-violet-50 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-sm font-semibold text-slate-800 mb-1">扫描重复文件</h3>
                        <p class="text-sm text-slate-500 mb-3">扫描 photos 目录中内容相同的重复文件（基于 MD5），便于选择删除多余副本。</p>
                        <div class="flex items-center gap-3">
                            <button type="button" id="dup-scan-btn" onclick="triggerScanDuplicates()"
                                    class="px-4 py-2 bg-violet-500 hover:bg-violet-600 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                开始扫描
                            </button>
                            <span id="dup-scan-status" class="text-sm text-slate-500"></span>
                        </div>
                        <div id="dup-result-empty" class="hidden mt-3 p-4 bg-slate-50 rounded-lg text-sm text-slate-600 text-center">未发现重复文件</div>
                        <div id="dup-result-container" class="hidden mt-3">
                            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                <span id="dup-result-summary" class="text-sm text-slate-600"></span>
                                <div class="flex items-center gap-2">
                                    <div class="relative" id="dup-batch-dropdown-wrap">
                                        <button type="button" id="dup-batch-btn" onclick="toggleDupBatchDropdown()"
                                                class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                            批量保留
                                        </button>
                                        <div id="dup-batch-dropdown" class="hidden absolute right-0 top-full mt-1 py-1 bg-white border border-slate-200 rounded-lg shadow-lg z-10 min-w-40">
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="newest">保留最新</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="oldest">保留最久</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="largest">保留最大</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="smallest">保留最小</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="path_longest">保留路径最长</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="path_shortest">保留路径最短</button>
                                            <button type="button" class="dup-batch-option w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50" data-strategy="path_contains">保留路径包含...</button>
                                        </div>
                                    </div>
                                    <button type="button" id="dup-delete-btn" onclick="deleteSelectedDuplicates()"
                                            class="px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        删除选中项
                                    </button>
                                </div>
                            </div>
                            <div id="dup-groups-list" class="space-y-4 max-h-[70vh] overflow-y-auto border border-slate-200 rounded-lg p-3 bg-slate-50"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======== 标签管理 ======== -->
        <div id="tab-tags" class="tab-content hidden">
            <div class="bg-white rounded-xl border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base font-semibold text-slate-800">标签列表</h2>
                    <div class="flex items-center gap-3">
                        <input type="text" id="tags-search-input" placeholder="搜索标签..."
                               class="px-3 py-2 text-sm border border-slate-200 rounded-lg bg-white text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-44">
                        <button type="button" onclick="loadTags()" class="text-sm text-blue-600 hover:text-blue-700 font-medium transition-colors">刷新</button>
                    </div>
                </div>
                <div id="tags-batch-actions" class="hidden mb-4 flex items-center gap-3">
                    <span id="tags-selected-count" class="text-sm text-slate-600">已选 0 项</span>
                    <button type="button" id="tags-merge-btn" onclick="mergeSelectedTags()"
                            class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        合并到...
                    </button>
                    <button type="button" id="tags-batch-delete-btn" onclick="batchDeleteSelectedTags()"
                            class="px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        批量删除
                    </button>
                </div>
                <div id="tags-list-container" class="border border-slate-200 rounded-lg overflow-hidden">
                    <div id="tags-list-loading" class="p-8 text-center text-slate-500 text-sm">加载中...</div>
                    <div id="tags-list-empty" class="hidden p-8 text-center text-slate-500 text-sm">暂无标签，可在图片预览中添加</div>
                    <table id="tags-list-table" class="hidden w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="w-10 px-2 py-3">
                                    <input type="checkbox" id="tags-select-all" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500" title="全选">
                                </th>
                                <th class="text-left px-4 py-3 font-medium text-slate-700">标签名</th>
                                <th class="text-left px-4 py-3 font-medium text-slate-700">关联图片数</th>
                                <th class="text-right px-4 py-3 font-medium text-slate-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tags-list-body" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ======== 关于 ======== -->
        <div id="tab-about" class="tab-content hidden">
            <div class="bg-white rounded-xl border border-slate-200 p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 002.25-2.25V5.25a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v13.5a2.25 2.25 0 002.25 2.25z"/></svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">FastPic</h2>
                        <p class="text-sm text-slate-500">轻量级本地图片查看器</p>
                    </div>
                </div>
                <div class="space-y-3 text-sm text-slate-600">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 w-20 flex-shrink-0">技术栈</span>
                        <span>FastAPI + Jinja2 + HTMX + Tailwind CSS</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 w-20 flex-shrink-0">数据库</span>
                        <span>SQLite (SQLModel / SQLAlchemy)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 w-20 flex-shrink-0">缩略图</span>
                        <span>Pillow (WebP, 300px)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自定义弹窗：统一风格 -->
<div id="settings-modal-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40" onclick="settingsModalCloseIfOverlay(event)">
    <div id="settings-modal-prompt" class="hidden w-full max-w-md bg-white rounded-xl border border-slate-200 shadow-xl" onclick="event.stopPropagation()">
        <div class="px-6 py-4 border-b border-slate-200">
            <h3 class="text-base font-semibold text-slate-800" id="settings-prompt-title">重命名标签</h3>
        </div>
        <div class="px-6 py-4">
            <input type="text" id="settings-prompt-input"
                   class="w-full px-3 py-2.5 text-sm border border-slate-200 rounded-lg bg-white text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="请输入新标签名">
            <p id="settings-prompt-error" class="hidden mt-2 text-sm text-red-600"></p>
        </div>
        <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
            <button type="button" id="settings-prompt-cancel"
                    class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                取消
            </button>
            <button type="button" id="settings-prompt-confirm"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
                确定
            </button>
        </div>
    </div>
    <div id="settings-modal-confirm" class="hidden w-full max-w-md bg-white rounded-xl border border-slate-200 shadow-xl" onclick="event.stopPropagation()">
        <div class="px-6 py-4 border-b border-slate-200">
            <h3 class="text-base font-semibold text-slate-800" id="settings-confirm-title">确认删除</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-sm text-slate-600" id="settings-confirm-message"></p>
        </div>
        <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
            <button type="button" id="settings-confirm-cancel"
                    class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                取消
            </button>
            <button type="button" id="settings-confirm-ok"
                    class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors">
                删除
            </button>
        </div>
    </div>
    <div id="settings-modal-alert" class="hidden w-full max-w-md bg-white rounded-xl border border-slate-200 shadow-xl" onclick="event.stopPropagation()">
        <div class="px-6 py-4 border-b border-slate-200">
            <h3 class="text-base font-semibold text-slate-800">提示</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-sm text-slate-600" id="settings-alert-message"></p>
        </div>
        <div class="px-6 py-4 border-t border-slate-100 flex justify-end">
            <button type="button" id="settings-alert-ok"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
                确定
            </button>
        </div>
    </div>
    <div id="settings-modal-merge" class="hidden w-full max-w-md bg-white rounded-xl border border-slate-200 shadow-xl" onclick="event.stopPropagation()">
        <div class="px-6 py-4 border-b border-slate-200">
            <h3 class="text-base font-semibold text-slate-800">合并到</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-sm text-slate-600 mb-3">将选中的标签合并到以下目标标签：</p>
            <select id="settings-merge-target" class="w-full px-3 py-2.5 text-sm border border-slate-200 rounded-lg bg-white text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </select>
        </div>
        <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
            <button type="button" id="settings-merge-cancel"
                    class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                取消
            </button>
            <button type="button" id="settings-merge-confirm"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
                合并
            </button>
        </div>
    </div>
</div>
<!-- 大图预览：独立于设置弹窗，仅点击缩略图时打开 -->
<div id="dup-preview-modal" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 bg-black/70">
    <div class="absolute inset-0" onclick="closeDupPreview(event)"></div>
    <div class="relative flex-1 flex items-center justify-center w-full max-h-[85vh] z-10" onclick="event.stopPropagation()">
        <button type="button" id="dup-preview-prev" class="absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white/20 hover:bg-white/40 text-white flex items-center justify-center text-xl disabled:opacity-30 disabled:cursor-not-allowed" title="上一张">‹</button>
        <img id="dup-preview-img" src="" alt="" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl">
        <button type="button" id="dup-preview-next" class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white/20 hover:bg-white/40 text-white flex items-center justify-center text-xl disabled:opacity-30 disabled:cursor-not-allowed" title="下一张">›</button>
    </div>
    <div id="dup-preview-toolbar" class="relative z-10 mt-3 w-full max-w-2xl flex items-center justify-between gap-4 px-4 py-3 bg-white/95 rounded-lg shadow-lg" onclick="event.stopPropagation()">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <label class="flex items-center gap-2 cursor-pointer flex-shrink-0">
                <input type="checkbox" id="dup-preview-delete-cb" class="rounded border-slate-300 text-red-600 focus:ring-red-500">
                <span class="text-sm text-slate-700">标记删除</span>
            </label>
            <span id="dup-preview-path" class="text-xs text-slate-500 truncate"></span>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
            <span id="dup-preview-counter" class="text-sm text-slate-600"></span>
            <button type="button" id="dup-preview-close" class="px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg">关闭</button>
        </div>
    </div>
</div>

<script>
// 自定义弹窗（统一风格）
function settingsModalCloseIfOverlay(e) {
    if (e.target.id === 'settings-modal-overlay') {
        document.getElementById('settings-modal-overlay').classList.add('hidden');
        document.getElementById('settings-modal-prompt').classList.add('hidden');
        document.getElementById('settings-modal-confirm').classList.add('hidden');
        document.getElementById('settings-modal-alert').classList.add('hidden');
        document.getElementById('settings-modal-merge').classList.add('hidden');
    }
}

var dupPreviewState = { groupIndex: -1, itemIndex: -1 };

function openDupPreview(photoUrl, groupIndex, itemIndex) {
    dupPreviewState = { groupIndex: groupIndex, itemIndex: itemIndex };
    var modal = document.getElementById('dup-preview-modal');
    var img = document.getElementById('dup-preview-img');
    img.src = photoUrl;
    modal.classList.remove('hidden');
    dupPreviewUpdateContent();
    dupPreviewSyncCheckboxFromList();
}

function dupPreviewUpdateContent() {
    var gi = dupPreviewState.groupIndex;
    var ii = dupPreviewState.itemIndex;
    if (gi < 0 || !dupGroupsCache || gi >= dupGroupsCache.length) return;
    var grp = dupGroupsCache[gi];
    var items = grp.items;
    if (ii < 0 || ii >= items.length) return;
    var item = items[ii];
    var photoUrl = '/photos/' + (item.relative_path || '').split('/').map(encodeURIComponent).join('/');
    document.getElementById('dup-preview-img').src = photoUrl;
    document.getElementById('dup-preview-path').textContent = item.relative_path || '';
    document.getElementById('dup-preview-counter').textContent = (ii + 1) + ' / ' + items.length;
    document.getElementById('dup-preview-prev').disabled = ii <= 0;
    document.getElementById('dup-preview-next').disabled = ii >= items.length - 1;
}

function dupPreviewSyncCheckboxFromList() {
    var cb = document.getElementById('dup-preview-delete-cb');
    var grp = dupGroupsCache && dupGroupsCache[dupPreviewState.groupIndex];
    if (!cb || !grp || dupPreviewState.itemIndex < 0 || dupPreviewState.itemIndex >= grp.items.length) return;
    var itemId = grp.items[dupPreviewState.itemIndex].id;
    var listCb = document.querySelector('.dup-group[data-group-index="' + dupPreviewState.groupIndex + '"] .dup-item-checkbox[data-id="' + itemId + '"]');
    if (listCb) cb.checked = listCb.checked;
}

function dupPreviewSyncListFromCheckbox() {
    var cb = document.getElementById('dup-preview-delete-cb');
    var grp = dupGroupsCache && dupGroupsCache[dupPreviewState.groupIndex];
    if (!grp || dupPreviewState.itemIndex < 0 || dupPreviewState.itemIndex >= grp.items.length) return;
    var itemId = grp.items[dupPreviewState.itemIndex].id;
    var listCb = document.querySelector('.dup-item-checkbox[data-id="' + itemId + '"]');
    if (listCb) {
        listCb.checked = cb.checked;
        updateDupDeleteBtn();
    }
}

function dupPreviewPrev() {
    if (dupPreviewState.itemIndex > 0) {
        dupPreviewState.itemIndex--;
        dupPreviewUpdateContent();
        dupPreviewSyncCheckboxFromList();
    }
}

function dupPreviewNext() {
    var grp = dupGroupsCache[dupPreviewState.groupIndex];
    if (dupPreviewState.itemIndex < grp.items.length - 1) {
        dupPreviewState.itemIndex++;
        dupPreviewUpdateContent();
        dupPreviewSyncCheckboxFromList();
    }
}

function closeDupPreview(e) {
    if (!e || e.target.id === 'dup-preview-modal') {
        document.getElementById('dup-preview-modal').classList.add('hidden');
        document.getElementById('dup-preview-img').src = '';
        dupPreviewState = { groupIndex: -1, itemIndex: -1 };
    }
}

document.addEventListener('keydown', function(e) {
    var modal = document.getElementById('dup-preview-modal');
    if (modal && !modal.classList.contains('hidden')) {
        if (e.key === 'Escape') closeDupPreview();
        else if (e.key === 'ArrowLeft') { dupPreviewPrev(); e.preventDefault(); }
        else if (e.key === 'ArrowRight') { dupPreviewNext(); e.preventDefault(); }
    }
});

(function() {
    var prev = document.getElementById('dup-preview-prev');
    var next = document.getElementById('dup-preview-next');
    var closeBtn = document.getElementById('dup-preview-close');
    var deleteCb = document.getElementById('dup-preview-delete-cb');
    if (prev) prev.onclick = dupPreviewPrev;
    if (next) next.onclick = dupPreviewNext;
    if (closeBtn) closeBtn.onclick = function() { closeDupPreview(); };
    if (deleteCb) deleteCb.onchange = dupPreviewSyncListFromCheckbox;
})();

function toggleDupBatchDropdown() {
    var dd = document.getElementById('dup-batch-dropdown');
    dd.classList.toggle('hidden');
}

document.addEventListener('click', function(e) {
    var wrap = document.getElementById('dup-batch-dropdown-wrap');
    if (wrap && !wrap.contains(e.target)) {
        document.getElementById('dup-batch-dropdown').classList.add('hidden');
    }
});

function showSettingsPrompt(title, defaultValue, onConfirm) {
    var overlay = document.getElementById('settings-modal-overlay');
    var modal = document.getElementById('settings-modal-prompt');
    var input = document.getElementById('settings-prompt-input');
    var errorEl = document.getElementById('settings-prompt-error');
    document.getElementById('settings-prompt-title').textContent = title;
    input.value = defaultValue || '';
    errorEl.classList.add('hidden');
    modal.classList.remove('hidden');
    overlay.classList.remove('hidden');
    input.focus();

    function close() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    }

    function done() {
        var val = input.value.trim();
        close();
        if (onConfirm) onConfirm(val);
    }

    document.getElementById('settings-prompt-cancel').onclick = function() { close(); };
    document.getElementById('settings-prompt-confirm').onclick = function() { done(); };
    input.onkeydown = function(e) {
        if (e.key === 'Enter') done();
        if (e.key === 'Escape') close();
    };
}

function showSettingsPromptWithValidation(title, defaultValue, onConfirm, validate) {
    var overlay = document.getElementById('settings-modal-overlay');
    var modal = document.getElementById('settings-modal-prompt');
    var input = document.getElementById('settings-prompt-input');
    var errorEl = document.getElementById('settings-prompt-error');
    document.getElementById('settings-prompt-title').textContent = title;
    input.value = defaultValue || '';
    errorEl.classList.add('hidden');
    modal.classList.remove('hidden');
    overlay.classList.remove('hidden');
    input.focus();

    function close() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    }

    function tryConfirm() {
        var val = input.value.trim();
        var err = validate ? validate(val) : null;
        if (err) {
            errorEl.textContent = err;
            errorEl.classList.remove('hidden');
            return;
        }
        close();
        if (onConfirm) onConfirm(val);
    }

    document.getElementById('settings-prompt-cancel').onclick = function() { close(); };
    document.getElementById('settings-prompt-confirm').onclick = tryConfirm;
    input.onkeydown = function(e) {
        if (e.key === 'Enter') tryConfirm();
        if (e.key === 'Escape') close();
    };
    input.oninput = function() { errorEl.classList.add('hidden'); };
}

function showSettingsConfirm(title, message, onConfirm) {
    var overlay = document.getElementById('settings-modal-overlay');
    var modal = document.getElementById('settings-modal-confirm');
    document.getElementById('settings-confirm-title').textContent = title;
    document.getElementById('settings-confirm-message').textContent = message;
    modal.classList.remove('hidden');
    overlay.classList.remove('hidden');

    function close() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    }

    document.getElementById('settings-confirm-cancel').onclick = close;
    document.getElementById('settings-confirm-ok').onclick = function() {
        close();
        if (onConfirm) onConfirm();
    };
}

function showSettingsAlert(message) {
    var overlay = document.getElementById('settings-modal-overlay');
    var modal = document.getElementById('settings-modal-alert');
    document.getElementById('settings-alert-message').textContent = message;
    modal.classList.remove('hidden');
    overlay.classList.remove('hidden');

    document.getElementById('settings-alert-ok').onclick = function() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    };
}

// 标签页切换
function switchTab(tabName) {
    // 更新按钮样式
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('border-blue-500', 'text-blue-600');
            btn.classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700');
        } else {
            btn.classList.remove('border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700');
        }
    });
    // 切换内容区
    document.querySelectorAll('.tab-content').forEach(function(content) {
        content.classList.add('hidden');
    });
    var target = document.getElementById('tab-' + tabName);
    if (target) target.classList.remove('hidden');
    if (tabName === 'tags') loadTags();
    if (tabName === 'duplicates' && dupGroupsCache.length > 0) renderDuplicateGroups(dupGroupsCache);
}

// 格式化文件大小
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    var units = ['B', 'KB', 'MB', 'GB', 'TB'];
    var i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
}

// 加载统计信息
function loadStats() {
    fetch('/api/stats').then(function(r) { return r.json(); }).then(function(data) {
        document.getElementById('stat-images').textContent = data.total_images.toLocaleString();
        document.getElementById('stat-folders').textContent = data.folder_count.toLocaleString();
        document.getElementById('stat-size').textContent = formatSize(data.total_size);
        document.getElementById('stat-cache').textContent = formatSize(data.cache_size) + ' (' + data.cache_count + ')';
        document.getElementById('stats-paths').innerHTML =
            '<div>图片目录：<span class="text-slate-600 font-mono">' + data.photos_dir + '</span></div>' +
            '<div>缓存目录：<span class="text-slate-600 font-mono">' + data.cache_dir + '</span></div>';
    }).catch(function(err) {
        console.error('加载统计失败:', err);
    });
}

// 扫描
function triggerScan() {
    var btn = document.getElementById('scan-btn');
    var status = document.getElementById('scan-status');
    btn.disabled = true;
    btn.textContent = '扫描中...';
    status.textContent = '';
    status.className = 'text-sm text-slate-500';

    fetch('/scan', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.textContent = '开始扫描';
            status.textContent = '扫描完成，新增 ' + data.scanned + ' 张图片';
            status.className = 'text-sm text-green-600';
            loadStats();
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.textContent = '开始扫描';
            status.textContent = '扫描失败: ' + err;
            status.className = 'text-sm text-red-500';
        });
}

// 清理
function triggerCleanup() {
    var btn = document.getElementById('cleanup-btn');
    var status = document.getElementById('cleanup-status');
    var resultEl = document.getElementById('cleanup-result');
    btn.disabled = true;
    btn.textContent = '清理中...';
    status.textContent = '';
    status.className = 'text-sm text-slate-500';
    resultEl.classList.add('hidden');

    fetch('/api/cleanup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.textContent = '开始清理';
            var total = data.stale_removed + data.orphan_cache_removed + data.cache_regenerated;
            if (total === 0) {
                status.textContent = '清理完成，数据已一致，无需处理';
                status.className = 'text-sm text-green-600';
            } else {
                status.textContent = '清理完成';
                status.className = 'text-sm text-green-600';
                resultEl.classList.remove('hidden');
                resultEl.innerHTML =
                    '<div>清除幽灵记录：<span class="font-medium text-slate-800">' + data.stale_removed + '</span> 条</div>' +
                    '<div>清除孤儿缓存：<span class="font-medium text-slate-800">' + data.orphan_cache_removed + '</span> 个</div>' +
                    '<div>重新生成缓存：<span class="font-medium text-slate-800">' + data.cache_regenerated + '</span> 个</div>';
            }
            loadStats();
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.textContent = '开始清理';
            status.textContent = '清理失败: ' + err;
            status.className = 'text-sm text-red-500';
        });
}

// 完整重建
function triggerRebuild() {
    var btn = document.getElementById('rebuild-btn');
    var status = document.getElementById('rebuild-status');
    var resultEl = document.getElementById('rebuild-result');
    btn.disabled = true;
    btn.textContent = '重建中...';
    status.textContent = '正在执行清理同步...';
    status.className = 'text-sm text-slate-500';
    resultEl.classList.add('hidden');

    // 先清理
    fetch('/api/cleanup', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(cleanupData) {
            status.textContent = '清理完成，正在扫描新图片...';
            // 再扫描
            return fetch('/scan', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(scanData) {
                    return { cleanup: cleanupData, scan: scanData };
                });
        })
        .then(function(result) {
            btn.disabled = false;
            btn.textContent = '完整重建';
            status.textContent = '重建完成';
            status.className = 'text-sm text-green-600';
            resultEl.classList.remove('hidden');
            resultEl.innerHTML =
                '<div class="font-medium text-slate-700 mb-1">清理结果：</div>' +
                '<div class="ml-3">清除幽灵记录：' + result.cleanup.stale_removed + ' 条</div>' +
                '<div class="ml-3">清除孤儿缓存：' + result.cleanup.orphan_cache_removed + ' 个</div>' +
                '<div class="ml-3">重新生成缓存：' + result.cleanup.cache_regenerated + ' 个</div>' +
                '<div class="font-medium text-slate-700 mt-2 mb-1">扫描结果：</div>' +
                '<div class="ml-3">新增图片：' + result.scan.scanned + ' 张</div>';
            loadStats();
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.textContent = '完整重建';
            status.textContent = '重建失败: ' + err;
            status.className = 'text-sm text-red-500';
        });
}

// 扫描重复文件
var dupGroupsCache = [];

function triggerScanDuplicates() {
    var btn = document.getElementById('dup-scan-btn');
    var status = document.getElementById('dup-scan-status');
    var emptyEl = document.getElementById('dup-result-empty');
    var containerEl = document.getElementById('dup-result-container');
    btn.disabled = true;
    btn.textContent = '扫描中...';
    status.textContent = '';
    status.className = 'text-sm text-slate-500';
    emptyEl.classList.add('hidden');
    containerEl.classList.add('hidden');

    fetch('/api/scan-duplicates', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.textContent = '开始扫描';
            dupGroupsCache = data.groups || [];
            if (dupGroupsCache.length === 0) {
                status.textContent = '扫描完成，未发现重复文件';
                status.className = 'text-sm text-green-600';
                emptyEl.classList.remove('hidden');
            } else {
                var totalDup = dupGroupsCache.reduce(function(sum, g) { return sum + g.items.length; }, 0);
                status.textContent = '扫描完成，发现 ' + dupGroupsCache.length + ' 组重复，共 ' + totalDup + ' 个文件';
                status.className = 'text-sm text-amber-600';
                containerEl.classList.remove('hidden');
                document.getElementById('dup-result-summary').textContent = '共 ' + dupGroupsCache.length + ' 组重复，勾选要删除的项';
                renderDuplicateGroups(dupGroupsCache);
                updateDupDeleteBtn();
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.textContent = '开始扫描';
            status.textContent = '扫描失败: ' + err;
            status.className = 'text-sm text-red-500';
        });
}

function renderDuplicateGroups(groups) {
    var listEl = document.getElementById('dup-groups-list');
    listEl.innerHTML = groups.map(function(grp, gi) {
        var itemsHtml = grp.items.map(function(item, ii) {
            var pathEsc = (item.relative_path || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            var nameEsc = (item.filename || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            var thumbSrc = '/cache/' + (item.cache_key || '');
            return '<div class="flex flex-col items-center gap-2 p-3 bg-white rounded-lg border border-slate-100 hover:border-slate-200">' +
                '<input type="checkbox" class="dup-item-checkbox rounded border-slate-300 text-red-600 focus:ring-red-500" data-id="' + item.id + '" data-group="' + gi + '" title="勾选以删除">' +
                '<a href="javascript:void(0)" class="dup-preview-thumb block" data-rel-path="' + pathEsc + '" data-group="' + gi + '" data-item="' + ii + '" onclick="var p=this.getAttribute(\'data-rel-path\'); var gi=parseInt(this.getAttribute(\'data-group\'),10); var ii=parseInt(this.getAttribute(\'data-item\'),10); openDupPreview(\'/photos/\'+p.split(\'/\').map(encodeURIComponent).join(\'/\'), gi, ii); return false;">' +
                '<img src="' + thumbSrc + '" alt="" class="w-24 h-24 sm:w-32 sm:h-32 object-cover rounded cursor-pointer hover:ring-2 hover:ring-violet-400 transition-all" onerror="this.style.display=\'none\'">' +
                '</a>' +
                '<div class="w-full min-w-0 text-center">' +
                '<div class="text-sm font-medium text-slate-800 truncate" title="' + pathEsc + '">' + nameEsc + '</div>' +
                '<div class="text-xs text-slate-500 truncate" title="' + pathEsc + '">' + pathEsc + '</div>' +
                '<div class="text-xs text-slate-400">' + formatSize(item.file_size || 0) + '</div>' +
                '</div></div>';
        }).join('');
        return '<div class="border border-slate-200 rounded-lg p-4 bg-white dup-group" data-group-index="' + gi + '">' +
            '<div class="text-xs text-slate-500 mb-3">第 ' + (gi + 1) + ' 组（' + grp.items.length + ' 个相同文件）</div>' +
            '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">' + itemsHtml + '</div></div>';
    }).join('');
    listEl.querySelectorAll('.dup-item-checkbox').forEach(function(cb) {
        cb.onchange = updateDupDeleteBtn;
    });
}

function getSelectedDupIds() {
    var ids = [];
    document.querySelectorAll('.dup-item-checkbox:checked').forEach(function(cb) {
        var id = parseInt(cb.getAttribute('data-id'), 10);
        if (!isNaN(id)) ids.push(id);
    });
    return ids;
}

function applyBatchKeep(pathFilter, strategy) {
    if (!dupGroupsCache || dupGroupsCache.length === 0) return;
    dupGroupsCache.forEach(function(grp, gi) {
        var items = grp.items;
        if (items.length < 2) return;
        var keepIndex = -1;
        if (strategy === 'newest') {
            var maxMt = -1;
            items.forEach(function(it, i) {
                var mt = it.modified_at || 0;
                if (mt > maxMt) { maxMt = mt; keepIndex = i; }
            });
        } else if (strategy === 'oldest') {
            var minMt = 1e15;
            items.forEach(function(it, i) {
                var mt = it.modified_at || 0;
                if (mt < minMt) { minMt = mt; keepIndex = i; }
            });
        } else if (strategy === 'largest') {
            var maxSz = -1;
            items.forEach(function(it, i) {
                var sz = it.file_size || 0;
                if (sz > maxSz) { maxSz = sz; keepIndex = i; }
            });
        } else if (strategy === 'smallest') {
            var minSz = 1e15;
            items.forEach(function(it, i) {
                var sz = it.file_size || 0;
                if (sz < minSz) { minSz = sz; keepIndex = i; }
            });
        } else if (strategy === 'path_longest') {
            var maxLen = -1;
            items.forEach(function(it, i) {
                var len = (it.relative_path || '').length;
                if (len > maxLen) { maxLen = len; keepIndex = i; }
            });
        } else if (strategy === 'path_shortest') {
            var minLen = 1e15;
            items.forEach(function(it, i) {
                var len = (it.relative_path || '').length;
                if (len < minLen) { minLen = len; keepIndex = i; }
            });
        } else if (strategy === 'path_contains' && pathFilter) {
            items.forEach(function(it, i) {
                if (keepIndex < 0 && (it.relative_path || '').indexOf(pathFilter) !== -1) keepIndex = i;
            });
        }
        if (keepIndex >= 0) {
            var groupEl = document.querySelector('.dup-group[data-group-index="' + gi + '"]');
            if (groupEl) {
                var cbs = groupEl.querySelectorAll('.dup-item-checkbox');
                cbs.forEach(function(cb, i) {
                    cb.checked = (i !== keepIndex);
                });
            }
        }
    });
    updateDupDeleteBtn();
}

function updateDupDeleteBtn() {
    var btn = document.getElementById('dup-delete-btn');
    var count = getSelectedDupIds().length;
    btn.disabled = count === 0;
    btn.textContent = count > 0 ? '删除选中项 (' + count + ')' : '删除选中项';
}

function deleteSelectedDuplicates() {
    var ids = getSelectedDupIds();
    if (ids.length === 0) {
        showSettingsAlert('请先勾选要删除的重复项');
        return;
    }
    closeDupPreview();
    showSettingsConfirm('确认删除', '确定要删除选中的 ' + ids.length + ' 个重复文件吗？将同时删除原图和数据库记录，此操作不可恢复。', function() {
        fetch('/api/delete-images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: ids })
        }).then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || r.statusText); });
            return r.json();
        }).then(function(data) {
            closeDupPreview();
            showSettingsAlert('已删除 ' + (data.deleted || 0) + ' 个文件');
            loadStats();
            triggerScanDuplicates();
        }).catch(function(err) {
            showSettingsAlert('删除失败: ' + err.message);
        });
    });
}

// 标签管理
var tagsSearchDebounceTimer = null;
var tagsSearchInput = document.getElementById('tags-search-input');
var tagsListCache = [];
if (tagsSearchInput) tagsSearchInput.addEventListener('input', function() {
    clearTimeout(tagsSearchDebounceTimer);
    tagsSearchDebounceTimer = setTimeout(loadTags, 300);
});

function getSelectedTagNames() {
    var rows = document.querySelectorAll('#tags-list-body tr[data-tag-name]');
    var names = [];
    rows.forEach(function(row) {
        var cb = row.querySelector('.tag-row-checkbox');
        if (cb && cb.checked) names.push(row.getAttribute('data-tag-name'));
    });
    return names;
}

function updateTagsBatchActions() {
    var actions = document.getElementById('tags-batch-actions');
    var countEl = document.getElementById('tags-selected-count');
    var mergeBtn = document.getElementById('tags-merge-btn');
    var batchDelBtn = document.getElementById('tags-batch-delete-btn');
    var selectAll = document.getElementById('tags-select-all');
    var rows = document.querySelectorAll('#tags-list-body .tag-row-checkbox');
    var selected = getSelectedTagNames();
    if (selected.length > 0) {
        actions.classList.remove('hidden');
        countEl.textContent = '已选 ' + selected.length + ' 项';
        mergeBtn.disabled = selected.length < 2;
        batchDelBtn.disabled = false;
    } else {
        actions.classList.add('hidden');
    }
    selectAll.checked = rows.length > 0 && selected.length === rows.length;
    selectAll.indeterminate = rows.length > 0 && selected.length > 0 && selected.length < rows.length;
}

function loadTags() {
    var loading = document.getElementById('tags-list-loading');
    var empty = document.getElementById('tags-list-empty');
    var table = document.getElementById('tags-list-table');
    var body = document.getElementById('tags-list-body');
    var q = (document.getElementById('tags-search-input').value || '').trim();

    loading.classList.remove('hidden');
    empty.classList.add('hidden');
    table.classList.add('hidden');
    document.getElementById('tags-batch-actions').classList.add('hidden');

    var url = '/api/tags?limit=200';
    if (q) url += '&q=' + encodeURIComponent(q);

    fetch(url).then(function(r) { return r.json(); }).then(function(data) {
        loading.classList.add('hidden');
        var tags = data.tags || [];
        tagsListCache = tags;
        if (tags.length === 0) {
            empty.classList.remove('hidden');
        } else {
            table.classList.remove('hidden');
            body.innerHTML = tags.map(function(t) {
                var raw = t.name || '';
                var name = raw.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                var attVal = raw.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return '<tr class="hover:bg-slate-50" data-tag-name="' + attVal + '">' +
                    '<td class="w-10 px-2 py-3"><input type="checkbox" class="tag-row-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500"></td>' +
                    '<td class="px-4 py-3 text-slate-800">#' + name + '</td>' +
                    '<td class="px-4 py-3 text-slate-600">' + (t.count || 0) + '</td>' +
                    '<td class="px-4 py-3 text-right">' +
                    '<button type="button" class="tag-rename-btn text-blue-600 hover:text-blue-700 text-xs font-medium mr-2">重命名</button>' +
                    '<button type="button" class="tag-delete-btn text-red-600 hover:text-red-700 text-xs font-medium">删除</button>' +
                    '</td></tr>';
            }).join('');
            body.querySelectorAll('.tag-rename-btn').forEach(function(btn) {
                btn.onclick = function() { renameTag(btn.closest('tr').getAttribute('data-tag-name')); };
            });
            body.querySelectorAll('.tag-delete-btn').forEach(function(btn) {
                btn.onclick = function() { deleteTag(btn.closest('tr').getAttribute('data-tag-name')); };
            });
            body.querySelectorAll('.tag-row-checkbox').forEach(function(cb) {
                cb.onchange = updateTagsBatchActions;
            });
        }
        var selectAllEl = document.getElementById('tags-select-all');
        selectAllEl.onchange = function() {
            var checked = selectAllEl.checked;
            body.querySelectorAll('.tag-row-checkbox').forEach(function(cb) { cb.checked = checked; });
            updateTagsBatchActions();
        };
    }).catch(function(err) {
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
        empty.textContent = '加载失败: ' + err;
    });
}

function mergeSelectedTags() {
    var selected = getSelectedTagNames();
    if (selected.length < 2) {
        showSettingsAlert('请至少选择两个标签进行合并');
        return;
    }
    var selectEl = document.getElementById('settings-merge-target');
    selectEl.innerHTML = tagsListCache.map(function(t) {
        var name = (t.name || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
        var val = (t.name || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return '<option value="' + val + '">#' + name + '</option>';
    }).join('');
    var overlay = document.getElementById('settings-modal-overlay');
    var modal = document.getElementById('settings-modal-merge');
    overlay.classList.remove('hidden');
    modal.classList.remove('hidden');

    function close() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    }

    document.getElementById('settings-merge-cancel').onclick = close;
    document.getElementById('settings-merge-confirm').onclick = function() {
        var targetName = selectEl.value;
        if (!targetName) {
            showSettingsAlert('请选择目标标签');
            return;
        }
        var toMerge = selected.filter(function(n) { return n !== targetName; });
        if (toMerge.length === 0) {
            showSettingsAlert('目标标签已在选中列表中，无需合并');
            close();
            return;
        }
        close();
        var promises = toMerge.map(function(name) {
            return fetch('/api/tags/' + encodeURIComponent(name) + '/merge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target: targetName })
            });
        });
        Promise.all(promises).then(function(responses) {
            var failed = responses.filter(function(r) { return !r.ok; });
            if (failed.length > 0) {
                failed[0].json().then(function(d) { showSettingsAlert('合并失败: ' + (d.detail || '未知错误')); });
            } else {
                loadTags();
            }
        }).catch(function(err) {
            showSettingsAlert('合并失败: ' + err.message);
        });
    };
}

function batchDeleteSelectedTags() {
    var selected = getSelectedTagNames();
    if (selected.length === 0) {
        showSettingsAlert('请先选择要删除的标签');
        return;
    }
    showSettingsConfirm('确认批量删除', '确定要删除选中的 ' + selected.length + ' 个标签吗？将同时移除这些标签在所有图片上的关联。', function() {
        fetch('/api/tags/batch-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ names: selected })
        }).then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || r.statusText); });
            return r.json();
        }).then(function(data) {
            loadTags();
            showSettingsAlert('已删除 ' + (data.deleted || 0) + ' 个标签');
        }).catch(function(err) {
            showSettingsAlert('批量删除失败: ' + err.message);
        });
    });
}

function renameTag(oldName) {
    showSettingsPromptWithValidation('重命名标签', oldName, function(newName) {
        if (newName === oldName) return;
        fetch('/api/tags/' + encodeURIComponent(oldName), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        }).then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || r.statusText); });
            return r.json();
        }).then(function() {
            loadTags();
        }).catch(function(err) {
            showSettingsAlert('重命名失败: ' + err.message);
        });
    }, function(val) {
        if (!val) return '标签名不能为空';
        if (val === oldName) return '新名称与原名称相同';
        return null;
    });
}

function deleteTag(name) {
    showSettingsConfirm('确认删除', '确定要删除标签「' + name + '」吗？将同时移除该标签在所有图片上的关联。', function() {
        fetch('/api/tags/' + encodeURIComponent(name), { method: 'DELETE' })
            .then(function(r) {
                if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || r.statusText); });
                return r.json();
            })
            .then(function() {
                loadTags();
            })
            .catch(function(err) {
                showSettingsAlert('删除失败: ' + err.message);
            });
    });
}

// 页面加载时获取统计
loadStats();

// 批量保留下拉选项（只绑定一次）
(function initDupBatchOptions() {
    document.querySelectorAll('.dup-batch-option').forEach(function(btn) {
        btn.onclick = function() {
            var strategy = btn.getAttribute('data-strategy');
            document.getElementById('dup-batch-dropdown').classList.add('hidden');
            if (strategy === 'path_contains') {
                showSettingsPrompt('路径包含的字符串', '', function(val) {
                    if (val) applyBatchKeep(val.trim(), 'path_contains');
                });
            } else {
                applyBatchKeep(null, strategy);
            }
        };
    });
})();
</script>
{% endblock %}
