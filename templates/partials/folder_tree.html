{% set current_path = current_path | default('') %}
{% set is_root = current_path == '' %}
<a href="/" data-path="" class="folder-link flex items-center px-3 py-2 rounded transition-colors {{ 'bg-blue-50 text-blue-600' if is_root else 'hover:bg-slate-100 text-slate-700' }}"
   hx-get="/gallery?path=&search=&page=1"
   hx-target="#gallery-container"
   hx-swap="innerHTML"
   hx-include="#mode-input, #sort-by-input, #sort-order-input"
   hx-on:click="document.querySelector('[name=path]').value = ''">
    <span class="truncate">/ 全部</span>
    {% if folder_counts.get('', 0) > 0 %}
    <span class="ml-auto text-xs {{ 'text-blue-400' if is_root else 'text-slate-400' }} pl-2 flex-shrink-0">{{ folder_counts.get('', 0) }}</span>
    {% endif %}
</a>
{% macro render_folder(prefix, children, depth) %}
{% for part, sub in children.items() %}
{% set path_parts = prefix + [part] %}
{% set path_str = path_parts|join('/') %}
{% set is_current = path_str == current_path %}
<div class="folder-node" data-path="{{ path_str }}">
    <div class="flex items-center group" style="padding-left: {{ 12 + depth * 16 }}px;">
        {% if sub %}
        <button type="button" class="folder-toggle w-5 h-5 flex-shrink-0 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 group-hover:text-slate-700 transition-colors"
                data-expanded="false"
                onclick="toggleFolder(this); event.stopPropagation();"
                aria-label="展开">
            <svg class="chevron w-3 h-3 transition-transform" viewBox="0 0 12 12" fill="currentColor"><path d="M4 2L8 6 4 10"/></svg>
        </button>
        {% else %}
        <span class="w-5 flex-shrink-0"></span>
        {% endif %}
        <a href="?path={{ path_str|urlencode_path }}"
           data-path="{{ path_str }}"
           class="folder-link flex-1 min-w-0 flex items-center px-2 py-1.5 rounded transition-colors {{ 'bg-blue-50 text-blue-600' if is_current else 'hover:bg-slate-100 text-slate-700' }}"
           hx-get="/gallery?path={{ path_str|urlencode_path }}&search=&page=1"
           hx-target="#gallery-container"
           hx-swap="innerHTML"
           hx-include="#mode-input, #sort-by-input, #sort-order-input"
           hx-on:click="document.querySelector('[name=path]').value = '{{ path_str }}'">
            <span class="truncate">{{ part }}</span>
            {% if folder_counts.get(path_str, 0) > 0 %}
            <span class="ml-auto text-xs {{ 'text-blue-400' if is_current else 'text-slate-400' }} pl-2 flex-shrink-0">{{ folder_counts.get(path_str, 0) }}</span>
            {% endif %}
        </a>
    </div>
    {% if sub %}
    <div class="folder-children hidden">
        {{ render_folder(path_parts, sub, depth + 1) }}
    </div>
    {% endif %}
</div>
{% endfor %}
{% endmacro %}
{{ render_folder([], nested_tree, 0) }}
