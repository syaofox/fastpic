{% extends "base.html" %}
{% block content %}
<div class="flex h-screen" id="layout">
    <!-- 左侧文件夹树（可调节宽度，默认隐藏） -->
    <aside id="sidebar" class="bg-white border-r border-slate-200 flex-shrink-0 flex flex-col hidden" style="width: var(--sidebar-width, 220px); min-width: 160px; max-width: 800px;">
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold text-slate-800">全部文件夹</h2>
                <button type="button" class="p-1 rounded hover:bg-slate-100 text-slate-500" aria-label="隐藏文件夹树" title="隐藏文件夹树" onclick="toggleSidebar()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
                </button>
            </div>
            <div class="space-y-0" id="folder-tree">
                {% set current_path = request.query_params.get('path') or '' %}
                {% include "partials/folder_tree.html" with context %}
            </div>
        </div>
        <div class="px-4 py-2 border-t border-slate-100 flex-shrink-0">
            <span class="text-xs text-slate-400">FastPic v{{ version }}</span>
        </div>
    </aside>

    <!-- 拖拽调节手柄（默认隐藏，跟随侧栏） -->
    <div id="resize-handle"
         class="flex-shrink-0 w-1.5 cursor-col-resize hover:bg-blue-100 transition-colors flex items-center justify-center group bg-slate-100 hidden"
         role="separator"
         aria-label="调节侧边栏宽度">
        <div class="w-0.5 h-8 bg-slate-400 group-hover:bg-blue-500 rounded-full opacity-60 group-hover:opacity-100 transition-opacity"></div>
    </div>

    <!-- 右侧主区 -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-50">
        <!-- 顶部栏：两行布局 -->
        <header class="bg-white border-b border-slate-200 flex-shrink-0 flex flex-col">
            <!-- 第一行：搜索框 | AI 搜索 | 设置 -->
            <div class="flex items-center gap-3 p-4 pb-0">
                <div class="flex-1 relative min-w-0" id="dir-search-wrapper">
                    <div class="flex items-center gap-2 pl-3 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500">
                        <svg class="w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        <input type="hidden" name="path" id="path-input" value="{{ request.query_params.get('path', '') or '' }}">
                        <input type="hidden" name="mode" id="mode-input" value="{{ request.query_params.get('mode', 'folder') }}">
                        <input type="search"
                               id="dir-search-input"
                               placeholder="搜索文件夹路径，如：2024、旅行、厦门..."
                               autocomplete="off"
                               class="flex-1 min-w-0 bg-transparent border-none focus:outline-none focus:ring-0 text-slate-800 placeholder-slate-400">
                    </div>
                    <div id="dir-search-dropdown" class="hidden absolute left-0 right-0 top-full mt-1 z-50 bg-white rounded-lg shadow-lg border border-slate-200 max-h-80 overflow-y-auto">
                    </div>
                </div>
                <button type="button" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors flex-shrink-0">AI 搜索</button>
                <a href="/settings" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors flex-shrink-0" title="设置"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></a>
            </div>
            <!-- 第二行：侧边栏按钮 | 面包屑 + 操作按钮 -->
            <div class="flex items-center gap-3 px-4 py-3">
                <button type="button" id="sidebar-toggle-btn"
                        class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors flex-shrink-0"
                        title="显示/隐藏文件夹树"
                        onclick="toggleSidebar()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                </button>
                <div id="gallery-top-slot" class="flex-1 min-w-0 overflow-hidden"></div>
            </div>
        </header>

        <!-- 图片网格 -->
        <div class="flex-1 overflow-y-auto p-4 transition-[padding] duration-200" id="scroll-container">
            <div id="gallery-container"
                 hx-get="/gallery?path={{ (request.query_params.get('path') or '')|urlencode_path }}&search=&mode={{ request.query_params.get('mode', 'folder') }}&sort_by={{ request.query_params.get('sort_by', 'modified_at') }}&sort_order={{ request.query_params.get('sort_order', 'desc') }}&page=1"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="flex justify-center items-center h-64 text-slate-500">
                    <span class="htmx-indicator">加载中...</span>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- 批量选择时底部固定操作栏（滚动后删除按钮始终可见） -->
<div id="select-mode-fab" class="hidden fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-slate-200 shadow-[0_-4px_12px_rgba(0,0,0,0.08)] px-4 py-3 flex items-center justify-between gap-4">
    <span id="select-mode-fab-count" class="text-sm font-medium text-slate-700">已选 0 项</span>
    <div class="flex items-center gap-2">
        <button type="button" id="select-mode-fab-move" class="hidden px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-colors flex items-center gap-1.5" onclick="window.showMoveDialog && window.showMoveDialog()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
            移动
        </button>
        <button type="button" class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" onclick="window.toggleSelectMode && window.toggleSelectMode()">取消选择</button>
        <button type="button" id="select-mode-fab-delete" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors flex items-center gap-1.5" onclick="window.confirmDeleteSelected && window.confirmDeleteSelected()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            删除
        </button>
    </div>
</div>

<!-- 大图预览模态框 -->
<div id="modal" class="fixed inset-0 z-50 hidden" onclick="closeModal(event)">
    <div id="modal-overlay" class="absolute inset-0 bg-black/80 flex items-center justify-center">
        <!-- 顶部工具栏 -->
        <div class="absolute top-0 left-0 right-0 flex items-center justify-between p-4 z-10" onclick="event.stopPropagation()">
            <!-- 左侧：幻灯片控件 -->
            <div class="flex items-center gap-2">
                <button type="button" id="slideshow-btn" onclick="toggleSlideshow(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="幻灯片播放">
                    <!-- 播放图标 -->
                    <svg id="slideshow-play-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <!-- 暂停图标 -->
                    <svg id="slideshow-pause-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
                <!-- 间隔设置 -->
                <div class="relative" id="slideshow-interval-wrapper">
                    <button type="button" id="slideshow-interval-btn" onclick="toggleSlideshowInterval(); event.stopPropagation();"
                            class="px-2.5 py-1.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white text-xs font-medium transition-all"
                            title="播放间隔">
                        <span id="slideshow-interval-label">2s</span>
                    </button>
                    <div id="slideshow-interval-popover" class="hidden absolute left-0 top-full mt-2 p-3 bg-slate-800/95 backdrop-blur rounded-lg shadow-xl border border-white/10 min-w-[200px]">
                        <div class="text-xs text-white/60 mb-2">播放间隔</div>
                        <input type="range" id="slideshow-interval-slider" min="1" max="10" step="0.5" value="2"
                               class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-blue-400"
                               oninput="updateSlideshowInterval(this.value)">
                        <div class="flex justify-between text-xs text-white/50 mt-1">
                            <span>1s</span>
                            <span id="slideshow-interval-value">2 秒</span>
                            <span>10s</span>
                        </div>
                        <div class="text-xs text-white/60 mt-3 mb-1">播放结束</div>
                        <div class="flex gap-2">
                            <button type="button" class="slideshow-mode-btn flex-1 px-2 py-1.5 rounded text-xs font-medium transition-colors" data-mode="loop" title="循环播放" onclick="setSlideshowMode('loop'); event.stopPropagation();">循环</button>
                            <button type="button" class="slideshow-mode-btn flex-1 px-2 py-1.5 rounded text-xs font-medium transition-colors" data-mode="stop" title="最后一张自动停止" onclick="setSlideshowMode('stop'); event.stopPropagation();">停止</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右侧：全屏 + 删除 + 关闭 -->
            <div class="flex items-center gap-2">
                <button type="button" id="modal-fullscreen-btn" onclick="toggleModalFullscreen(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="全屏查看 (F)">
                    <!-- 进入全屏图标 -->
                    <svg id="fullscreen-enter-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                    <!-- 退出全屏图标 -->
                    <svg id="fullscreen-exit-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 9L4 4m5 0H4v5m16-5l-5 5m5-5h-5v5M4 20l5-5m-5 5h5v-5m11 5l-5-5m5 5h-5v-5"/></svg>
                </button>
                <button type="button" id="modal-info-btn" onclick="showImageInfo(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="图片信息">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
                <button type="button" id="modal-move-btn" onclick="window.showMoveDialogForCurrentImage && window.showMoveDialogForCurrentImage(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="移动到其他文件夹">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                </button>
                <button type="button" id="modal-delete-btn" onclick="deleteCurrentImage(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-red-500/80 text-white/80 hover:text-white transition-all"
                        title="删除当前图片">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
                <button type="button" onclick="closeModalAndStopSlideshow(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="关闭">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>
        <button type="button" onclick="prevImage(); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/20 hover:bg-white/40 text-white text-2xl flex items-center justify-center">‹</button>
        <img id="modal-img" src="" alt="" class="max-w-[90vw] max-h-[90vh] object-contain" onclick="event.stopPropagation()">
        <button type="button" onclick="nextImage(); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/20 hover:bg-white/40 text-white text-2xl flex items-center justify-center">›</button>
        <div id="modal-image-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-full bg-black/50 text-white/90 text-sm font-medium" onclick="event.stopPropagation()">1/1</div>
    </div>
</div>

<!-- 图片信息弹框 -->
<div id="image-info-popup" class="fixed inset-0 z-[60] hidden flex items-center justify-center" onclick="closeImageInfoPopup(event)">
    <div id="image-info-overlay" class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-10 bg-slate-800/95 backdrop-blur rounded-xl shadow-xl border border-white/10 max-w-lg w-[90vw] max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
            <span class="text-sm font-semibold text-white">图片信息</span>
            <button type="button" onclick="closeImageInfoPopup(event)" class="p-1.5 rounded hover:bg-white/10 text-white/80 hover:text-white transition-colors" title="关闭">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div id="image-info-content" class="p-4 overflow-y-auto max-h-[60vh] text-sm text-white/90 space-y-2 font-mono">
            <div class="text-white/50">加载中...</div>
        </div>
    </div>
</div>

<script>
// 侧边栏开关（默认隐藏，localStorage 持久化）
(function() {
    const SIDEBAR_VISIBLE_KEY = 'fastpic_sidebar_visible';

    function isSidebarVisible() {
        return localStorage.getItem(SIDEBAR_VISIBLE_KEY) === 'true';
    }

    function applySidebarState(visible) {
        const sidebar = document.getElementById('sidebar');
        const handle = document.getElementById('resize-handle');
        const btn = document.getElementById('sidebar-toggle-btn');
        if (visible) {
            sidebar.classList.remove('hidden');
            handle.classList.remove('hidden');
            btn.classList.add('bg-blue-50', 'text-blue-600');
            btn.classList.remove('text-slate-500');
        } else {
            sidebar.classList.add('hidden');
            handle.classList.add('hidden');
            btn.classList.remove('bg-blue-50', 'text-blue-600');
            btn.classList.add('text-slate-500');
        }
    }

    // 页面加载时恢复状态
    applySidebarState(isSidebarVisible());

    // 全局切换函数
    window.toggleSidebar = function() {
        const visible = !isSidebarVisible();
        localStorage.setItem(SIDEBAR_VISIBLE_KEY, String(visible));
        applySidebarState(visible);
    };
})();

function toggleFolder(btn) {
    const node = btn.closest('.folder-node');
    const children = node.querySelector(':scope > .folder-children');
    if (!children) return;
    const expanded = btn.getAttribute('data-expanded') === 'true';
        if (expanded) {
            children.classList.add('hidden');
            btn.querySelector('.chevron').classList.remove('-rotate-90');
            btn.setAttribute('data-expanded', 'false');
            btn.setAttribute('aria-label', '展开');
        } else {
            children.classList.remove('hidden');
            btn.querySelector('.chevron').classList.add('-rotate-90');
            btn.setAttribute('data-expanded', 'true');
            btn.setAttribute('aria-label', '折叠');
        }
}

let modalImages = [];
let modalImageIds = [];
let modalIndex = 0;
let slideshowTimer = null;
let slideshowInterval = parseFloat(localStorage.getItem('fastpic_slideshow_interval') || '2');
let slideshowMode = localStorage.getItem('fastpic_slideshow_mode') || 'loop';

function openModal(photoUrl, index, allUrls, allIds) {
    modalImages = allUrls;
    modalImageIds = allIds || [];
    modalIndex = index;
    document.getElementById('modal-img').src = photoUrl;
    document.getElementById('modal').classList.remove('hidden');
    // 同步间隔、播放模式和序号显示
    _updateIntervalUI(slideshowInterval);
    _updateSlideshowModeUI(slideshowMode);
    _updateModalImageCounter();
}

function closeModal(e) {
    if (e.target.id === 'modal' || e.target.id === 'modal-overlay') {
        stopSlideshow();
        if (document.fullscreenElement) document.exitFullscreen();
        document.getElementById('modal').classList.add('hidden');
    }
}

function closeModalAndStopSlideshow() {
    stopSlideshow();
    if (document.fullscreenElement) document.exitFullscreen();
    document.getElementById('modal').classList.add('hidden');
}

function showImageInfo() {
    if (modalImageIds.length === 0 || modalIndex < 0 || modalIndex >= modalImageIds.length) {
        var content = document.getElementById('image-info-content');
        content.innerHTML = '<div class="text-white/70">暂无图片信息</div>';
        document.getElementById('image-info-popup').classList.remove('hidden');
        document.getElementById('image-info-popup').classList.add('flex');
        return;
    }
    var imageId = modalImageIds[modalIndex];
    var content = document.getElementById('image-info-content');
    content.innerHTML = '<div class="text-white/50">加载中...</div>';
    document.getElementById('image-info-popup').classList.remove('hidden');
    document.getElementById('image-info-popup').classList.add('flex');

    fetch('/api/image-info/' + imageId)
        .then(function(res) {
            if (!res.ok) {
                if (res.status === 404) return Promise.reject('图片不存在或已被删除');
                return Promise.reject('获取信息失败');
            }
            return res.json();
        })
        .then(function(data) {
            content.innerHTML =
                '<div class="flex justify-between gap-4"><span class="text-white/50 flex-shrink-0">完整路径</span><span class="break-all text-right">' + escapeHtml(data.full_path) + '</span></div>' +
                '<div class="flex justify-between gap-4"><span class="text-white/50 flex-shrink-0">文件名</span><span class="break-all text-right">' + escapeHtml(data.filename) + '</span></div>' +
                '<div class="flex justify-between gap-4"><span class="text-white/50 flex-shrink-0">分辨率</span><span>' + escapeHtml(data.resolution) + '</span></div>' +
                '<div class="flex justify-between gap-4"><span class="text-white/50 flex-shrink-0">文件大小</span><span>' + escapeHtml(data.file_size) + '</span></div>' +
                '<div class="flex justify-between gap-4"><span class="text-white/50 flex-shrink-0">修改时间</span><span>' + escapeHtml(data.modified_at) + '</span></div>';
        })
        .catch(function(err) {
            content.innerHTML = '<div class="text-red-300">' + escapeHtml(String(err)) + '</div>';
        });
}

function closeImageInfoPopup(e) {
    if (e.target.id === 'image-info-popup' || e.target.id === 'image-info-overlay' || e.target.closest('button')) {
        document.getElementById('image-info-popup').classList.add('hidden');
        document.getElementById('image-info-popup').classList.remove('flex');
    }
}

function escapeHtml(s) {
    if (s == null) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

function prevImage() {
    if (modalImages.length === 0) return;
    modalIndex = (modalIndex - 1 + modalImages.length) % modalImages.length;
    document.getElementById('modal-img').src = modalImages[modalIndex];
    _updateModalImageCounter();
    refreshImageInfoIfVisible();
}

function nextImage(fromSlideshow) {
    if (modalImages.length === 0) return;
    if (modalIndex === modalImages.length - 1) {
        if (!fromSlideshow) {
            showCustomConfirm('已经是最后一张，是否从头开始？', '从头开始', function() {
                modalIndex = 0;
                document.getElementById('modal-img').src = modalImages[modalIndex];
                _updateModalImageCounter();
                refreshImageInfoIfVisible();
            });
            return;
        }
        if (slideshowMode === 'stop') {
            stopSlideshow();
            return;
        }
        modalIndex = 0;
    } else {
        modalIndex = modalIndex + 1;
    }
    document.getElementById('modal-img').src = modalImages[modalIndex];
    _updateModalImageCounter();
    refreshImageInfoIfVisible();
}

function showCustomConfirm(message, confirmText, onConfirm, onCancel) {
    var old = document.getElementById('custom-confirm-dialog');
    if (old) old.remove();

    var overlay = document.createElement('div');
    overlay.id = 'custom-confirm-dialog';
    overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
    overlay.innerHTML =
        '<div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6" onclick="event.stopPropagation()">' +
            '<p class="text-slate-700 mb-6 text-center">' + escapeHtml(message) + '</p>' +
            '<div class="flex justify-center gap-3">' +
                '<button type="button" class="custom-confirm-cancel px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                '<button type="button" class="custom-confirm-ok px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-colors">' + escapeHtml(confirmText || '确定') + '</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(overlay);

    overlay.querySelector('.custom-confirm-ok').addEventListener('click', function() {
        overlay.remove();
        if (onConfirm) onConfirm();
    });
    overlay.querySelector('.custom-confirm-cancel').addEventListener('click', function() {
        overlay.remove();
        if (onCancel) onCancel();
    });
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
            overlay.remove();
            if (onCancel) onCancel();
        }
    });
}

function refreshImageInfoIfVisible() {
    var popup = document.getElementById('image-info-popup');
    if (popup && !popup.classList.contains('hidden')) {
        showImageInfo();
    }
}

// ── 幻灯片播放 ──

function toggleSlideshow() {
    if (slideshowTimer) {
        stopSlideshow();
    } else {
        startSlideshow();
    }
}

function startSlideshow() {
    if (modalImages.length <= 1) return;
    if (slideshowTimer) return;
    slideshowTimer = setInterval(function() {
        nextImage(true);
    }, slideshowInterval * 1000);
    // 更新按钮外观
    var playIcon = document.getElementById('slideshow-play-icon');
    var pauseIcon = document.getElementById('slideshow-pause-icon');
    var btn = document.getElementById('slideshow-btn');
    if (playIcon) playIcon.classList.add('hidden');
    if (pauseIcon) pauseIcon.classList.remove('hidden');
    if (btn) { btn.classList.add('bg-blue-500/60'); btn.classList.remove('bg-white/15'); }
}

function stopSlideshow() {
    if (slideshowTimer) {
        clearInterval(slideshowTimer);
        slideshowTimer = null;
    }
    var playIcon = document.getElementById('slideshow-play-icon');
    var pauseIcon = document.getElementById('slideshow-pause-icon');
    var btn = document.getElementById('slideshow-btn');
    if (playIcon) playIcon.classList.remove('hidden');
    if (pauseIcon) pauseIcon.classList.add('hidden');
    if (btn) { btn.classList.remove('bg-blue-500/60'); btn.classList.add('bg-white/15'); }
}

function toggleSlideshowInterval() {
    var popover = document.getElementById('slideshow-interval-popover');
    if (popover) popover.classList.toggle('hidden');
}

function updateSlideshowInterval(val) {
    slideshowInterval = parseFloat(val);
    localStorage.setItem('fastpic_slideshow_interval', String(slideshowInterval));
    _updateIntervalUI(slideshowInterval);
    // 如果正在播放，重启计时器以使用新间隔
    if (slideshowTimer) {
        stopSlideshow();
        startSlideshow();
    }
}

function _updateIntervalUI(val) {
    var label = document.getElementById('slideshow-interval-label');
    var valueText = document.getElementById('slideshow-interval-value');
    var slider = document.getElementById('slideshow-interval-slider');
    var display = val % 1 === 0 ? val + ' 秒' : val.toFixed(1) + ' 秒';
    if (label) label.textContent = val % 1 === 0 ? val + 's' : val.toFixed(1) + 's';
    if (valueText) valueText.textContent = display;
    if (slider) slider.value = val;
}

function _updateSlideshowModeUI(mode) {
    var btns = document.querySelectorAll('.slideshow-mode-btn');
    btns.forEach(function(btn) {
        if (btn.getAttribute('data-mode') === mode) {
            btn.classList.add('bg-blue-500/60', 'text-white');
            btn.classList.remove('bg-white/15', 'text-white/80');
        } else {
            btn.classList.remove('bg-blue-500/60', 'text-white');
            btn.classList.add('bg-white/15', 'text-white/80');
        }
    });
}

function setSlideshowMode(mode) {
    slideshowMode = mode;
    localStorage.setItem('fastpic_slideshow_mode', mode);
    _updateSlideshowModeUI(mode);
}

function _updateModalImageCounter() {
    var el = document.getElementById('modal-image-counter');
    if (!el) return;
    var total = modalImages.length;
    var current = modalIndex + 1;
    el.textContent = current + '/' + total;
}

// ── 全屏查看 ──

function toggleModalFullscreen() {
    var modal = document.getElementById('modal');
    if (!document.fullscreenElement) {
        modal.requestFullscreen().catch(function(err) {
            console.warn('无法进入全屏:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function _updateFullscreenUI() {
    var enterIcon = document.getElementById('fullscreen-enter-icon');
    var exitIcon = document.getElementById('fullscreen-exit-icon');
    var btn = document.getElementById('modal-fullscreen-btn');
    if (document.fullscreenElement) {
        if (enterIcon) enterIcon.classList.add('hidden');
        if (exitIcon) exitIcon.classList.remove('hidden');
        if (btn) btn.title = '退出全屏 (F)';
    } else {
        if (enterIcon) enterIcon.classList.remove('hidden');
        if (exitIcon) exitIcon.classList.add('hidden');
        if (btn) btn.title = '全屏查看 (F)';
    }
}

document.addEventListener('fullscreenchange', _updateFullscreenUI);

// 点击模态框外部区域关闭间隔弹窗
document.addEventListener('click', function(e) {
    var popover = document.getElementById('slideshow-interval-popover');
    var wrapper = document.getElementById('slideshow-interval-wrapper');
    if (popover && !popover.classList.contains('hidden') && wrapper && !wrapper.contains(e.target)) {
        popover.classList.add('hidden');
    }
});

function deleteCurrentImage() {
    if (modalImages.length === 0 || modalImageIds.length === 0) return;
    var imageId = modalImageIds[modalIndex];
    if (!imageId) return;

    // 简单确认
    if (!confirm('确定要删除这张图片吗？此操作不可恢复。')) return;

    var btn = document.getElementById('modal-delete-btn');
    if (btn) btn.disabled = true;

    fetch('/api/delete-images', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: [imageId]})
    }).then(function(r) { return r.json(); }).then(function(data) {
        // 从列表中移除当前图片
        modalImages.splice(modalIndex, 1);
        modalImageIds.splice(modalIndex, 1);

        if (modalImages.length === 0) {
            // 没有图片了，关闭模态框并刷新画廊
            document.getElementById('modal').classList.add('hidden');
            refreshGalleryFromModal();
        } else {
            // 调整索引，显示下一张（或最后一张）
            if (modalIndex >= modalImages.length) {
                modalIndex = modalImages.length - 1;
            }
            document.getElementById('modal-img').src = modalImages[modalIndex];
            _updateModalImageCounter();
            refreshImageInfoIfVisible();
            // 刷新画廊（后台更新网格）
            refreshGalleryFromModal();
        }
        if (btn) btn.disabled = false;
    }).catch(function(err) {
        console.error('删除失败:', err);
        alert('删除失败');
        if (btn) btn.disabled = false;
    });
}

function refreshGalleryFromModal() {
    var marker = document.getElementById('current-path-marker');
    var path = marker ? (marker.getAttribute('data-path') || '') : '';
    var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
    var sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
    var sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
    var filters = (typeof window.getFilterState === 'function') ? window.getFilterState() : {};
    var url = '/gallery?path=' + encodeURIComponent(path) + '&search=&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1' +
        '&filter_filename=' + encodeURIComponent(filters.filter_filename || '') +
        '&filter_size_min=' + encodeURIComponent(filters.filter_size_min || '') +
        '&filter_size_max=' + encodeURIComponent(filters.filter_size_max || '') +
        '&filter_date_from=' + encodeURIComponent(filters.filter_date_from || '') +
        '&filter_date_to=' + encodeURIComponent(filters.filter_date_to || '');
    htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('modal');
    if (modal.classList.contains('hidden')) return;
    if (e.key === 'Escape') {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            stopSlideshow(); modal.classList.add('hidden');
        }
    }
    if (e.key === 'ArrowLeft') { stopSlideshow(); prevImage(); }
    if (e.key === 'ArrowRight') { stopSlideshow(); nextImage(); }
    if (e.key === 'Delete' || e.key === 'Backspace') { deleteCurrentImage(); }
    if (e.key === ' ') { e.preventDefault(); toggleSlideshow(); }
    if (e.key === 'f' || e.key === 'F') { toggleModalFullscreen(); }
});

// 大图模式：触摸滑动切换图片
(function() {
    var overlay = document.getElementById('modal-overlay');
    if (!overlay) return;
    var startX = 0, startY = 0;
    var SWIPE_THRESHOLD = 50;
    overlay.addEventListener('touchstart', function(e) {
        if (e.touches.length !== 1) return;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }, {passive: true});
    overlay.addEventListener('touchend', function(e) {
        if (e.changedTouches.length !== 1) return;
        var endX = e.changedTouches[0].clientX;
        var endY = e.changedTouches[0].clientY;
        var dx = endX - startX;
        var dy = endY - startY;
        if (Math.abs(dx) < SWIPE_THRESHOLD) return;
        if (Math.abs(dx) < Math.abs(dy)) return;
        stopSlideshow();
        if (dx > 0) prevImage();
        else nextImage();
    }, {passive: true});
})();

// 缩略图大小调节
(function() {
    const STORAGE_KEY = 'fastpic_gallery_cols';
    const DEFAULT_COLS = 4;
    const MIN_COLS = 2;
    const MAX_COLS = 8;

    function getScrollContainer() {
        return document.getElementById('scroll-container');
    }

    function initThumbnailSize() {
        const saved = localStorage.getItem(STORAGE_KEY);
        const cols = saved ? Math.max(MIN_COLS, Math.min(MAX_COLS, parseInt(saved, 10))) : DEFAULT_COLS;
        const sc = getScrollContainer();
        if (sc) sc.style.setProperty('--gallery-cols', String(cols));
    }

    function setThumbnailCols(cols) {
        const c = Math.max(MIN_COLS, Math.min(MAX_COLS, cols));
        const sc = getScrollContainer();
        if (sc) sc.style.setProperty('--gallery-cols', String(c));
        localStorage.setItem(STORAGE_KEY, String(c));
        const valEl = document.getElementById('thumbnail-size-value');
        if (valEl) valEl.textContent = c + ' 列';
        const slider = document.getElementById('thumbnail-size-slider');
        if (slider) slider.value = c;
        // 瀑布流模式下重建列布局
        if (typeof window.rebuildWaterfall === 'function') window.rebuildWaterfall();
    }

    initThumbnailSize();

    function positionThumbnailSizePopover(btn, popover) {
        const rect = btn.getBoundingClientRect();
        const popW = 200;
        let top = rect.bottom + 8;
        let left = rect.left;
        if (left + popW > window.innerWidth - 8) left = window.innerWidth - popW - 8;
        if (left < 8) left = 8;
        const popH = popover.scrollHeight || 120;
        if (top + popH > window.innerHeight - 8) {
            top = rect.top - popH - 8;
            if (top < 8) top = 8;
        }
        popover.style.top = top + 'px';
        popover.style.left = left + 'px';
    }

    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('#thumbnail-size-btn');
        const popover = document.getElementById('thumbnail-size-popover');
        const insidePopover = popover && popover.contains(e.target);
        if (btn) {
            popover.classList.toggle('hidden');
            if (!popover.classList.contains('hidden')) {
                positionThumbnailSizePopover(btn, popover);
                const slider = document.getElementById('thumbnail-size-slider');
                const saved = localStorage.getItem(STORAGE_KEY);
                const cols = saved ? parseInt(saved, 10) : DEFAULT_COLS;
                if (slider) slider.value = Math.max(MIN_COLS, Math.min(MAX_COLS, cols));
                setThumbnailCols(cols);
            }
        } else if (popover && !popover.classList.contains('hidden') && !insidePopover) {
            popover.classList.add('hidden');
        }
    });

    document.body.addEventListener('input', function(e) {
        if (e.target.id === 'thumbnail-size-slider') {
            setThumbnailCols(parseInt(e.target.value, 10));
        }
    });
})();

// 侧边栏宽度调节
(function() {
    const SIDEBAR_MIN = 160;
    const SIDEBAR_MAX = 800;
    const STORAGE_KEY = 'fastpic_sidebar_width';

    function initSidebarWidth() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const w = parseInt(saved, 10);
            if (w >= SIDEBAR_MIN && w <= SIDEBAR_MAX) {
                document.documentElement.style.setProperty('--sidebar-width', w + 'px');
            }
        }
    }

    function setSidebarWidth(px) {
        const w = Math.max(SIDEBAR_MIN, Math.min(SIDEBAR_MAX, px));
        document.documentElement.style.setProperty('--sidebar-width', w + 'px');
        localStorage.setItem(STORAGE_KEY, String(w));
    }

    initSidebarWidth();

    const handle = document.getElementById('resize-handle');
    const sidebar = document.getElementById('sidebar');

    handle.addEventListener('mousedown', function(e) {
        if (e.button !== 0) return;
        e.preventDefault();
        const startX = e.clientX;
        const startWidth = sidebar.getBoundingClientRect().width;

        function onMouseMove(e) {
            const dx = e.clientX - startX;
            setSidebarWidth(startWidth + dx);
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
})();

// 瀑布流布局管理器（JS 多列，避免 CSS columns 重排）
(function() {
    var wfColumns = [];
    var wfHeights = [];
    var wfInitialized = false;

    function getColCount() {
        var saved = localStorage.getItem('fastpic_gallery_cols');
        return saved ? Math.max(2, Math.min(8, parseInt(saved, 10))) : 4;
    }

    function isWaterfallMode() {
        var marker = document.getElementById('current-path-marker');
        return marker && marker.getAttribute('data-mode') === 'waterfall';
    }

    function getShortestCol() {
        var minIdx = 0;
        for (var i = 1; i < wfHeights.length; i++) {
            if (wfHeights[i] < wfHeights[minIdx]) minIdx = i;
        }
        return minIdx;
    }

    function getItemHeight(item) {
        var w = parseInt(item.getAttribute('data-w')) || 0;
        var h = parseInt(item.getAttribute('data-h')) || 0;
        if (w > 0 && h > 0) return (h / w) * 1000;
        return 1000;
    }

    function placeItem(item) {
        var idx = getShortestCol();
        wfColumns[idx].appendChild(item);
        wfHeights[idx] += getItemHeight(item);
    }

    function initWaterfall() {
        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var colCount = getColCount();

        // 收集所有直接子元素（图片卡片 + 滚动哨兵）
        var items = [];
        var sentinel = null;
        Array.from(grid.children).forEach(function(child) {
            if (child.classList && child.classList.contains('selectable-item')) {
                items.push(child);
            } else if (child.tagName === 'A') {
                items.push(child);
            } else if (child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinel = child;
            }
        });

        // 移除旧元素
        items.forEach(function(item) { item.remove(); });
        if (sentinel) sentinel.remove();

        // 移除可能存在的旧 wf-row
        var oldRow = document.getElementById('wf-row');
        if (oldRow) oldRow.remove();

        // 创建列容器
        var row = document.createElement('div');
        row.id = 'wf-row';
        grid.appendChild(row);

        wfColumns = [];
        wfHeights = new Array(colCount).fill(0);
        for (var i = 0; i < colCount; i++) {
            var col = document.createElement('div');
            col.className = 'wf-col';
            row.appendChild(col);
            wfColumns.push(col);
        }

        // 按最短列分配图片
        items.forEach(function(item) { placeItem(item); });

        // 哨兵放在 grid 最后（在列容器下方，确保滚动到底部才触发）
        if (sentinel) grid.appendChild(sentinel);

        wfInitialized = true;
    }

    function distributeNew() {
        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var wfRow = document.getElementById('wf-row');
        if (!wfRow) return;

        // 找到所有不在 wf-row 中的直接子元素（HTMX 追加的新内容）
        var newImages = [];
        var sentinels = [];
        Array.from(grid.children).forEach(function(child) {
            if (child === wfRow) return;
            if (child.classList && child.classList.contains('selectable-item')) {
                newImages.push(child);
            } else if (child.tagName === 'A') {
                newImages.push(child);
            } else if (child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinels.push(child);
            }
        });

        // 将新图片分配到最短列
        newImages.forEach(function(item) {
            item.remove();
            placeItem(item);
        });

        // 只保留最新的哨兵，移除旧的
        if (sentinels.length > 1) {
            sentinels.slice(0, -1).forEach(function(s) { s.remove(); });
        }
    }

    function rebuildWaterfall() {
        if (!isWaterfallMode() || !wfInitialized) return;

        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var wfRow = document.getElementById('wf-row');
        if (!wfRow) return;

        // 从各列中收集所有图片
        var items = [];
        wfColumns.forEach(function(col) {
            Array.from(col.children).forEach(function(child) {
                items.push(child);
            });
        });

        // 收集哨兵
        var sentinel = null;
        Array.from(grid.children).forEach(function(child) {
            if (child !== wfRow && child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinel = child;
            }
        });

        // 清空
        wfRow.remove();
        if (sentinel) sentinel.remove();

        // 重新放回 grid
        items.forEach(function(item) { grid.appendChild(item); });
        if (sentinel) grid.appendChild(sentinel);

        // 重新初始化
        initWaterfall();
    }

    // 暴露给外部（缩略图大小改变时调用）
    window.rebuildWaterfall = rebuildWaterfall;

    // 监听 HTMX 交换事件
    document.body.addEventListener('htmx:afterSettle', function(ev) {
        if (ev.detail.target.id === 'gallery-container') {
            // 全量加载（首页 / 切换模式 / 切换文件夹）
            wfInitialized = false;
            wfColumns = [];
            wfHeights = [];
            if (isWaterfallMode()) {
                initWaterfall();
            }
        } else if (ev.detail.target.id === 'gallery-grid' && wfInitialized && isWaterfallMode()) {
            // 追加加载（无限滚动）
            distributeNew();
        } else if (ev.detail.target.id === 'gallery-grid' && !isWaterfallMode()) {
            // 文件夹模式追加加载：清理旧的滚动哨兵，只保留最新的
            var grid = document.getElementById('gallery-grid');
            if (grid) {
                var sentinels = grid.querySelectorAll(':scope > .scroll-sentinel');
                if (sentinels.length > 1) {
                    for (var i = 0; i < sentinels.length - 1; i++) {
                        sentinels[i].remove();
                    }
                }
            }
        }
    });
})();

// ---------- 新建文件夹 ----------
(function() {
    function getCurrentPath() {
        var marker = document.getElementById('current-path-marker');
        return marker ? (marker.getAttribute('data-path') || '') : '';
    }

    window.showCreateFolderDialog = function() {
        var old = document.getElementById('create-folder-dialog');
        if (old) old.remove();

        var overlay = document.createElement('div');
        overlay.id = 'create-folder-dialog';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
        overlay.innerHTML =
            '<div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">' +
                '<div class="flex items-center gap-3 mb-4">' +
                    '<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">' +
                        '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>' +
                    '</div>' +
                    '<h3 class="text-lg font-semibold text-slate-800">新建文件夹</h3>' +
                '</div>' +
                '<div class="mb-2 text-sm text-slate-500">位置：<span class="font-medium text-slate-700">' + (getCurrentPath() || '根目录') + '</span></div>' +
                '<input type="text" id="new-folder-name" placeholder="输入文件夹名称" ' +
                    'class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-1">' +
                '<div id="create-folder-error" class="text-sm text-red-500 mb-4 hidden"></div>' +
                '<div class="flex justify-end gap-3 mt-4">' +
                    '<button type="button" class="cancel-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                    '<button type="button" class="confirm-btn px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-colors">创建</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        var input = overlay.querySelector('#new-folder-name');
        var errorEl = overlay.querySelector('#create-folder-error');
        setTimeout(function() { input.focus(); }, 50);

        function doCreate() {
            var name = input.value.trim();
            if (!name) { errorEl.textContent = '名称不能为空'; errorEl.classList.remove('hidden'); return; }
            if (/[\/\\]/.test(name) || name.includes('..')) { errorEl.textContent = '名称不能包含 / \\ 或 ..'; errorEl.classList.remove('hidden'); return; }

            var confirmBtn = overlay.querySelector('.confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '创建中...';

            fetch('/api/create-folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: getCurrentPath(), name: name})
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.ok) {
                    overlay.remove();
                    // 刷新画廊
                    refreshGalleryFromModal();
                } else {
                    errorEl.textContent = data.error || '创建失败';
                    errorEl.classList.remove('hidden');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '创建';
                }
            }).catch(function(err) {
                errorEl.textContent = '请求失败: ' + err;
                errorEl.classList.remove('hidden');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '创建';
            });
        }

        overlay.querySelector('.cancel-btn').addEventListener('click', function() { overlay.remove(); });
        overlay.querySelector('.confirm-btn').addEventListener('click', doCreate);
        input.addEventListener('keydown', function(e) { if (e.key === 'Enter') doCreate(); if (e.key === 'Escape') overlay.remove(); });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
    };
})();

// ---------- 上传图片 ----------
(function() {
    function getCurrentPath() {
        var marker = document.getElementById('current-path-marker');
        return marker ? (marker.getAttribute('data-path') || '') : '';
    }

    window.showUploadDialog = function() {
        var old = document.getElementById('upload-dialog');
        if (old) old.remove();

        var overlay = document.createElement('div');
        overlay.id = 'upload-dialog';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
        overlay.innerHTML =
            '<div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 p-6">' +
                '<div class="flex items-center gap-3 mb-4">' +
                    '<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">' +
                        '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>' +
                    '</div>' +
                    '<h3 class="text-lg font-semibold text-slate-800">上传图片</h3>' +
                '</div>' +
                '<div class="mb-3 text-sm text-slate-500">上传到：<span class="font-medium text-slate-700">' + (getCurrentPath() || '根目录') + '</span></div>' +
                '<div id="upload-drop-zone" class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">' +
                    '<svg class="w-10 h-10 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 002.25-2.25V5.25a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v13.5a2.25 2.25 0 002.25 2.25z"/></svg>' +
                    '<p class="text-sm text-slate-600 mb-1">拖拽图片到此处，或</p>' +
                    '<button type="button" class="browse-btn text-sm text-blue-600 hover:text-blue-700 font-medium underline">浏览文件</button>' +
                    '<input type="file" id="upload-file-input" multiple accept="image/*" class="hidden">' +
                    '<p class="text-xs text-slate-400 mt-2">支持 JPG、PNG、GIF、WebP、BMP</p>' +
                '</div>' +
                '<div class="mt-3 flex items-center gap-3 text-sm text-slate-600">' +
                    '<span class="flex-shrink-0">重复文件：</span>' +
                    '<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="on_duplicate" value="skip" checked class="accent-blue-500"> 跳过</label>' +
                    '<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="on_duplicate" value="rename" class="accent-blue-500"> 重命名</label>' +
                    '<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="on_duplicate" value="overwrite" class="accent-blue-500"> 覆盖</label>' +
                '</div>' +
                '<div id="upload-file-list" class="mt-3 max-h-40 overflow-y-auto hidden"></div>' +
                '<div id="upload-progress-wrapper" class="mt-3 hidden">' +
                    '<div class="flex items-center justify-between text-sm text-slate-600 mb-1">' +
                        '<span id="upload-progress-text">上传中...</span>' +
                        '<span id="upload-progress-count"></span>' +
                    '</div>' +
                    '<div class="w-full bg-slate-200 rounded-full h-2">' +
                        '<div id="upload-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>' +
                    '</div>' +
                '</div>' +
                '<div id="upload-error" class="text-sm text-red-500 mt-2 hidden"></div>' +
                '<div class="flex justify-end gap-3 mt-4">' +
                    '<button type="button" class="cancel-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                    '<button type="button" class="upload-confirm-btn px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>上传</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        var dropZone = overlay.querySelector('#upload-drop-zone');
        var fileInput = overlay.querySelector('#upload-file-input');
        var browseBtn = overlay.querySelector('.browse-btn');
        var fileList = overlay.querySelector('#upload-file-list');
        var confirmBtn = overlay.querySelector('.upload-confirm-btn');
        var progressWrapper = overlay.querySelector('#upload-progress-wrapper');
        var progressBar = overlay.querySelector('#upload-progress-bar');
        var progressText = overlay.querySelector('#upload-progress-text');
        var progressCount = overlay.querySelector('#upload-progress-count');
        var errorEl = overlay.querySelector('#upload-error');
        var selectedFiles = [];

        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                confirmBtn.disabled = true;
                return;
            }
            fileList.classList.remove('hidden');
            confirmBtn.disabled = false;
            var html = '';
            for (var i = 0; i < selectedFiles.length; i++) {
                var f = selectedFiles[i];
                var sizeMB = (f.size / 1024 / 1024).toFixed(1);
                html += '<div class="flex items-center justify-between py-1.5 px-2 text-sm ' + (i > 0 ? 'border-t border-slate-100' : '') + '">' +
                    '<span class="text-slate-700 truncate flex-1 mr-2">' + f.name + '</span>' +
                    '<span class="text-slate-400 text-xs flex-shrink-0">' + sizeMB + ' MB</span>' +
                    '<button type="button" class="remove-file ml-2 text-slate-400 hover:text-red-500 flex-shrink-0" data-idx="' + i + '">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
                    '</button>' +
                '</div>';
            }
            fileList.innerHTML = html;
            confirmBtn.textContent = '上传 (' + selectedFiles.length + ')';

            fileList.querySelectorAll('.remove-file').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    selectedFiles.splice(parseInt(this.getAttribute('data-idx')), 1);
                    updateFileList();
                });
            });
        }

        function addFiles(files) {
            for (var i = 0; i < files.length; i++) {
                if (files[i].type.startsWith('image/')) {
                    selectedFiles.push(files[i]);
                }
            }
            updateFileList();
        }

        browseBtn.addEventListener('click', function(e) { e.stopPropagation(); fileInput.click(); });
        dropZone.addEventListener('click', function() { fileInput.click(); });
        fileInput.addEventListener('change', function() { addFiles(this.files); this.value = ''; });

        dropZone.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('border-blue-400', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', function(e) { e.preventDefault(); this.classList.remove('border-blue-400', 'bg-blue-50'); });
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('border-blue-400', 'bg-blue-50');
            if (e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
        });

        confirmBtn.addEventListener('click', function() {
            if (selectedFiles.length === 0) return;
            confirmBtn.disabled = true;
            progressWrapper.classList.remove('hidden');
            dropZone.classList.add('hidden');
            fileList.classList.add('hidden');

            var formData = new FormData();
            formData.append('path', getCurrentPath());
            var dupRadio = overlay.querySelector('input[name="on_duplicate"]:checked');
            formData.append('on_duplicate', dupRadio ? dupRadio.value : 'skip');
            for (var i = 0; i < selectedFiles.length; i++) {
                formData.append('files', selectedFiles[i]);
            }

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload');

            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    var pct = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = pct + '%';
                    progressCount.textContent = pct + '%';
                }
            });

            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    progressText.textContent = '上传完成';
                    progressBar.style.width = '100%';
                    var summary = data.uploaded + ' 张成功';
                    if (data.skipped > 0) summary += '，' + data.skipped + ' 张跳过（重复）';
                    progressCount.textContent = summary;
                    if (data.errors && data.errors.length > 0) {
                        errorEl.textContent = '部分失败: ' + data.errors.join('; ');
                        errorEl.classList.remove('hidden');
                    }
                    var delay = (data.errors && data.errors.length > 0) ? 2500 : 500;
                    setTimeout(function() {
                        overlay.remove();
                        refreshGalleryFromModal();
                    }, delay);
                } else {
                    progressText.textContent = '上传失败';
                    errorEl.textContent = '服务器返回 ' + xhr.status;
                    errorEl.classList.remove('hidden');
                    confirmBtn.disabled = false;
                }
            });

            xhr.addEventListener('error', function() {
                progressText.textContent = '上传失败';
                errorEl.textContent = '网络错误';
                errorEl.classList.remove('hidden');
                confirmBtn.disabled = false;
            });

            xhr.send(formData);
        });

        overlay.querySelector('.cancel-btn').addEventListener('click', function() { overlay.remove(); });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
    };
})();

// 排序下拉菜单
(function() {
    function getCurrentSort() {
        var sortByInput = document.getElementById('sort-by-input');
        var sortOrderInput = document.getElementById('sort-order-input');
        return {
            sort_by: sortByInput ? sortByInput.value : 'modified_at',
            sort_order: sortOrderInput ? sortOrderInput.value : 'desc'
        };
    }

    function triggerSort(sortBy, sortOrder) {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        var sortByInput = document.getElementById('sort-by-input');
        var sortOrderInput = document.getElementById('sort-order-input');
        if (sortByInput) sortByInput.value = sortBy;
        if (sortOrderInput) sortOrderInput.value = sortOrder;

        var filters = (typeof window.getFilterState === 'function') ? window.getFilterState() : {};
        var encodedPath = encodeURIComponent(path);
        var url = '/gallery?path=' + encodedPath + '&search=&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1' +
            '&filter_filename=' + encodeURIComponent(filters.filter_filename || '') +
            '&filter_size_min=' + encodeURIComponent(filters.filter_size_min || '') +
            '&filter_size_max=' + encodeURIComponent(filters.filter_size_max || '') +
            '&filter_date_from=' + encodeURIComponent(filters.filter_date_from || '') +
            '&filter_date_to=' + encodeURIComponent(filters.filter_date_to || '');

        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('#sort-btn');
        var popover = document.getElementById('sort-popover');
        var insidePopover = popover && popover.contains(e.target);

        // 点击排序字段选项
        var fieldOption = e.target.closest('.sort-field-option');
        if (fieldOption && popover && popover.contains(fieldOption)) {
            var current = getCurrentSort();
            triggerSort(fieldOption.getAttribute('data-sort-field'), current.sort_order);
            popover.classList.add('hidden');
            return;
        }

        // 点击排序顺序选项
        var orderOption = e.target.closest('.sort-order-option');
        if (orderOption && popover && popover.contains(orderOption)) {
            var current = getCurrentSort();
            triggerSort(current.sort_by, orderOption.getAttribute('data-sort-order'));
            popover.classList.add('hidden');
            return;
        }

        // 切换排序弹出框
        if (btn) {
            if (popover) {
                popover.classList.toggle('hidden');
                if (!popover.classList.contains('hidden')) {
                    var rect = btn.getBoundingClientRect();
                    var popW = 160;
                    var top = rect.bottom + 8;
                    var left = rect.right - popW;
                    if (left < 8) left = 8;
                    var popH = popover.scrollHeight || 220;
                    if (top + popH > window.innerHeight - 8) {
                        top = rect.top - popH - 8;
                        if (top < 8) top = 8;
                    }
                    popover.style.top = top + 'px';
                    popover.style.left = left + 'px';
                }
            }
        } else if (popover && !popover.classList.contains('hidden') && !insidePopover) {
            popover.classList.add('hidden');
        }
    });
})();

// ---------- 批量选择 & 删除 ----------
(function() {
    window._selectMode = false;
    var _selectedImages = new Set();  // image ids
    var _selectedFolders = new Set(); // folder paths

    function isSelectMode() { return window._selectMode; }

    function enterSelectMode() {
        window._selectMode = true;
        var btn = document.getElementById('select-mode-btn');
        if (btn) { btn.classList.add('bg-blue-100', 'text-blue-600'); btn.classList.remove('hover:bg-slate-100', 'hover:text-slate-700'); }
        var selAllBtn = document.getElementById('select-all-btn');
        if (selAllBtn) selAllBtn.classList.remove('hidden');
        // 显示所有复选框
        document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.remove('hidden'); });
    }

    function exitSelectMode() {
        window._selectMode = false;
        _selectedImages.clear();
        _selectedFolders.clear();
        var btn = document.getElementById('select-mode-btn');
        if (btn) { btn.classList.remove('bg-blue-100', 'text-blue-600'); btn.classList.add('hover:bg-slate-100', 'hover:text-slate-700'); }
        var selAllBtn = document.getElementById('select-all-btn');
        if (selAllBtn) selAllBtn.classList.add('hidden');
        var delBtn = document.getElementById('delete-selected-btn');
        if (delBtn) delBtn.classList.add('hidden');
        var moveBtn = document.getElementById('move-selected-btn');
        if (moveBtn) moveBtn.classList.add('hidden');
        // 隐藏底部固定操作栏
        var fab = document.getElementById('select-mode-fab');
        if (fab) fab.classList.add('hidden');
        var scrollEl = document.getElementById('scroll-container');
        if (scrollEl) scrollEl.classList.remove('pb-24');
        // 隐藏复选框，取消选中效果
        document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.add('hidden'); });
        document.querySelectorAll('.selectable-item').forEach(function(item) { uncheckItem(item); });
    }

    window.toggleSelectMode = function() {
        if (isSelectMode()) { exitSelectMode(); } else { enterSelectMode(); }
    };

    function checkItem(item) {
        item.setAttribute('data-selected', 'true');
        var overlay = item.querySelector('.select-overlay');
        if (overlay) overlay.classList.remove('hidden');
        var cbDiv = item.querySelector('.select-checkbox > div');
        if (cbDiv) { cbDiv.classList.add('bg-blue-500', 'border-blue-500'); cbDiv.classList.remove('bg-white/80'); }
        var icon = item.querySelector('.check-icon');
        if (icon) icon.classList.remove('hidden');
    }

    function uncheckItem(item) {
        item.removeAttribute('data-selected');
        var overlay = item.querySelector('.select-overlay');
        if (overlay) overlay.classList.add('hidden');
        var cbDiv = item.querySelector('.select-checkbox > div');
        if (cbDiv) { cbDiv.classList.remove('bg-blue-500', 'border-blue-500'); cbDiv.classList.add('bg-white/80'); }
        var icon = item.querySelector('.check-icon');
        if (icon) icon.classList.add('hidden');
    }

    function updateDeleteButton() {
        var total = _selectedImages.size + _selectedFolders.size;
        var imgCount = _selectedImages.size;
        var delBtn = document.getElementById('delete-selected-btn');
        var moveBtn = document.getElementById('move-selected-btn');
        var fabMoveBtn = document.getElementById('select-mode-fab-move');
        var countText = document.getElementById('delete-count-text');
        var fab = document.getElementById('select-mode-fab');
        var fabCount = document.getElementById('select-mode-fab-count');
        var scrollEl = document.getElementById('scroll-container');
        if (total > 0) {
            if (delBtn) delBtn.classList.remove('hidden');
            if (countText) countText.textContent = '删除 (' + total + ')';
            if (moveBtn) (imgCount > 0 ? moveBtn.classList.remove('hidden') : moveBtn.classList.add('hidden'));
            if (fabMoveBtn) (imgCount > 0 ? fabMoveBtn.classList.remove('hidden') : fabMoveBtn.classList.add('hidden'));
            if (fab) fab.classList.remove('hidden');
            if (fabCount) fabCount.textContent = '已选 ' + total + ' 项';
            if (scrollEl) scrollEl.classList.add('pb-24');
        } else {
            if (delBtn) delBtn.classList.add('hidden');
            if (moveBtn) moveBtn.classList.add('hidden');
            if (fabMoveBtn) fabMoveBtn.classList.add('hidden');
            if (fab) fab.classList.add('hidden');
            if (scrollEl) scrollEl.classList.remove('pb-24');
        }
    }

    window.handleItemClick = function(event, item) {
        if (!isSelectMode()) {
            // 非选择模式：文件夹正常导航，图片正常预览
            return;
        }
        // 选择模式下阻止所有导航/链接
        event.preventDefault();
        event.stopPropagation();

        var type = item.getAttribute('data-type');
        var isSelected = item.getAttribute('data-selected') === 'true';

        if (isSelected) {
            uncheckItem(item);
            if (type === 'image') _selectedImages.delete(parseInt(item.getAttribute('data-image-id')));
            if (type === 'folder') _selectedFolders.delete(item.getAttribute('data-folder-path'));
        } else {
            checkItem(item);
            if (type === 'image') _selectedImages.add(parseInt(item.getAttribute('data-image-id')));
            if (type === 'folder') _selectedFolders.add(item.getAttribute('data-folder-path'));
        }
        updateDeleteButton();
    };

    window.toggleSelectAll = function() {
        var items = document.querySelectorAll('.selectable-item');
        // 判断是全选还是取消全选
        var allSelected = true;
        items.forEach(function(item) {
            if (item.getAttribute('data-selected') !== 'true') allSelected = false;
        });
        items.forEach(function(item) {
            var type = item.getAttribute('data-type');
            if (allSelected) {
                uncheckItem(item);
                if (type === 'image') _selectedImages.delete(parseInt(item.getAttribute('data-image-id')));
                if (type === 'folder') _selectedFolders.delete(item.getAttribute('data-folder-path'));
            } else {
                checkItem(item);
                if (type === 'image') _selectedImages.add(parseInt(item.getAttribute('data-image-id')));
                if (type === 'folder') _selectedFolders.add(item.getAttribute('data-folder-path'));
            }
        });
        updateDeleteButton();
    };

    window.confirmDeleteSelected = function() {
        var imgCount = _selectedImages.size;
        var folderCount = _selectedFolders.size;
        if (imgCount === 0 && folderCount === 0) return;

        var msg = '确定要删除以下内容吗？\n\n';
        if (folderCount > 0) msg += '• ' + folderCount + ' 个文件夹（包含其中所有图片）\n';
        if (imgCount > 0) msg += '• ' + imgCount + ' 张图片\n';
        msg += '\n此操作不可恢复！';

        // 显示自定义确认对话框
        showDeleteConfirmDialog(msg, function() {
            executeDelete(Array.from(_selectedImages), Array.from(_selectedFolders));
        });
    };

    function showDeleteConfirmDialog(message, onConfirm) {
        // 移除之前的对话框（如果有）
        var old = document.getElementById('delete-confirm-dialog');
        if (old) old.remove();

        var overlay = document.createElement('div');
        overlay.id = 'delete-confirm-dialog';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
        overlay.innerHTML =
            '<div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">' +
                '<div class="flex items-center gap-3 mb-4">' +
                    '<div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">' +
                        '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' +
                    '</div>' +
                    '<h3 class="text-lg font-semibold text-slate-800">确认删除</h3>' +
                '</div>' +
                '<pre class="text-sm text-slate-600 mb-6 whitespace-pre-wrap font-sans">' + message.replace(/</g, '&lt;') + '</pre>' +
                '<div class="flex justify-end gap-3">' +
                    '<button type="button" class="cancel-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                    '<button type="button" class="confirm-btn px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors">确认删除</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        overlay.querySelector('.cancel-btn').addEventListener('click', function() { overlay.remove(); });
        overlay.querySelector('.confirm-btn').addEventListener('click', function() {
            overlay.remove();
            onConfirm();
        });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
    }

    function executeDelete(imageIds, folderPaths) {
        var delBtn = document.getElementById('delete-selected-btn');
        var fabDelBtn = document.getElementById('select-mode-fab-delete');
        if (delBtn) {
            delBtn.disabled = true;
            var countText = delBtn.querySelector('#delete-count-text');
            if (countText) countText.textContent = '删除中...';
        }
        if (fabDelBtn) {
            fabDelBtn.disabled = true;
            fabDelBtn.innerHTML = '<span>删除中...</span>';
        }

        var promises = [];

        if (imageIds.length > 0) {
            promises.push(
                fetch('/api/delete-images', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: imageIds})
                }).then(function(r) { return r.json(); })
            );
        }

        if (folderPaths.length > 0) {
            promises.push(
                fetch('/api/delete-folders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({paths: folderPaths})
                }).then(function(r) { return r.json(); })
            );
        }

        Promise.all(promises).then(function(results) {
            // 退出选择模式
            exitSelectMode();
            // 刷新画廊和侧栏文件夹树
            refreshGallery();
            if (folderPaths.length > 0) refreshSidebar();
        }).catch(function(err) {
            console.error('删除失败:', err);
            alert('删除失败，请查看控制台日志');
            if (delBtn) delBtn.disabled = false;
            if (fabDelBtn) {
                fabDelBtn.disabled = false;
                fabDelBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>\n            删除';
            }
            updateDeleteButton();
        });
    }

    function getCurrentPathForMove() {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var pathInput = document.querySelector('[name=path]');
        if (pathInput) path = pathInput.value || path;
        return path || '';
    }

    window.showMoveDialog = function(imageIdsOrNull, options) {
        var imgIds = imageIdsOrNull !== undefined && imageIdsOrNull !== null
            ? (Array.isArray(imageIdsOrNull) ? imageIdsOrNull : [imageIdsOrNull])
            : Array.from(_selectedImages);
        if (imgIds.length === 0) return;
        var fromModal = options && options.fromModal;

        var old = document.getElementById('move-dialog');
        if (old) old.remove();

        var overlay = document.createElement('div');
        overlay.id = 'move-dialog';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
        overlay.innerHTML =
            '<div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[85vh] flex flex-col">' +
                '<div class="p-4 border-b border-slate-200 flex-shrink-0">' +
                    '<div class="flex items-center gap-3 mb-2">' +
                        '<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">' +
                            '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>' +
                        '</div>' +
                        '<h3 class="text-lg font-semibold text-slate-800">移动图片</h3>' +
                    '</div>' +
                    '<div class="text-sm text-slate-500">将 ' + imgIds.length + ' 张图片移动到：</div>' +
                    '<nav id="move-breadcrumb" class="mt-2 flex items-center gap-1 text-sm text-slate-600 flex-wrap"></nav>' +
                '</div>' +
                '<div id="move-folder-list" class="flex-1 overflow-y-auto p-4 min-h-0"></div>' +
                '<div class="p-4 border-t border-slate-200 flex-shrink-0 flex justify-end gap-2">' +
                    '<button type="button" class="move-cancel-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                    '<button type="button" class="move-confirm-btn px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-colors">移动到这里</button>' +
                '</div>' +
                '<div id="move-error" class="hidden px-4 pb-4 text-sm text-red-500"></div>' +
            '</div>';

        document.body.appendChild(overlay);

        var currentPath = (options && options.initialPath !== undefined) ? options.initialPath : getCurrentPathForMove();
        var breadcrumbEl = overlay.querySelector('#move-breadcrumb');
        var listEl = overlay.querySelector('#move-folder-list');
        var confirmBtn = overlay.querySelector('.move-confirm-btn');
        var errorEl = overlay.querySelector('#move-error');

        function renderBreadcrumb() {
            var parts = currentPath ? currentPath.split('/') : [];
            var html = '<a href="#" class="move-nav-link" data-path="">全部文件夹</a>';
            for (var i = 0; i < parts.length; i++) {
                var path = parts.slice(0, i + 1).join('/');
                html += '<span class="text-slate-400"> › </span>';
                html += '<a href="#" class="move-nav-link" data-path="' + path.replace(/"/g, '&quot;') + '">' + parts[i] + '</a>';
            }
            breadcrumbEl.innerHTML = html;
            breadcrumbEl.querySelectorAll('.move-nav-link').forEach(function(a) {
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPath = a.getAttribute('data-path') || '';
                    renderBreadcrumb();
                    loadSubfolders();
                });
            });
        }

        function loadSubfolders() {
            listEl.innerHTML = '<div class="text-slate-400 text-sm py-4">加载中...</div>';
            fetch('/api/subfolders?path=' + encodeURIComponent(currentPath))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var subs = data.subfolders || [];
                    if (subs.length === 0) {
                        listEl.innerHTML = '<div class="text-slate-400 text-sm py-4">' + (currentPath ? '此文件夹下没有子文件夹' : '暂无文件夹') + '</div>';
                    } else {
                        listEl.innerHTML = subs.map(function(s) {
                            return '<div class="move-folder-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors" data-path="' + (s.full_path || '').replace(/"/g, '&quot;') + '">' +
                                '<svg class="w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>' +
                                '<span class="font-medium text-slate-700">' + (s.name || '').replace(/</g, '&lt;') + '</span>' +
                                (s.image_count > 0 ? '<span class="text-xs text-slate-400 ml-auto">' + s.image_count + ' 张</span>' : '') +
                                '</div>';
                        }).join('');
                        listEl.querySelectorAll('.move-folder-item').forEach(function(el) {
                            el.addEventListener('click', function() {
                                currentPath = el.getAttribute('data-path') || '';
                                renderBreadcrumb();
                                loadSubfolders();
                            });
                        });
                    }
                })
                .catch(function(err) {
                    listEl.innerHTML = '<div class="text-red-500 text-sm py-4">加载失败</div>';
                });
        }

        function doMove() {
            errorEl.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '移动中...';

            fetch('/api/move-images', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ids: imgIds, target_path: currentPath})
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                overlay.remove();
                if (data.moved > 0) {
                    var moved = data.moved;
                    var errs = data.errors || [];
                    if (fromModal && options && options.onSuccess) {
                        options.onSuccess();
                    } else {
                        imgIds.forEach(function(id) { _selectedImages.delete(id); });
                        updateDeleteButton();
                        if (_selectedImages.size === 0 && _selectedFolders.size === 0) { exitSelectMode(); }
                    }
                    if (errs.length > 0) {
                        alert('已移动 ' + moved + ' 张，失败 ' + errs.length + ' 张：' + errs.join('；'));
                    }
                    if (!fromModal) refreshGallery();
                } else {
                    if (data.errors && data.errors.length > 0) {
                        errorEl.textContent = data.errors.join('；');
                        errorEl.classList.remove('hidden');
                    } else {
                        errorEl.textContent = '所选图片已在目标位置';
                        errorEl.classList.remove('hidden');
                    }
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '移动到这里';
                }
            })
            .catch(function(err) {
                console.error('移动失败:', err);
                errorEl.textContent = '请求失败: ' + err;
                errorEl.classList.remove('hidden');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '移动到这里';
            });
        }

        overlay.querySelector('.move-cancel-btn').addEventListener('click', function() { overlay.remove(); });
        confirmBtn.addEventListener('click', doMove);
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });

        renderBreadcrumb();
        loadSubfolders();
    };

    window.showMoveDialogForCurrentImage = function() {
        if (modalImageIds.length === 0 || modalIndex >= modalImageIds.length) return;
        var id = modalImageIds[modalIndex];
        if (!id) return;
        window.showMoveDialog([id], {
            fromModal: true,
            initialPath: getCurrentPathForMove(),
            onSuccess: function() {
                modalImages.splice(modalIndex, 1);
                modalImageIds.splice(modalIndex, 1);
                if (modalImages.length === 0) {
                    document.getElementById('modal').classList.add('hidden');
                } else {
                    if (modalIndex >= modalImages.length) modalIndex = modalImages.length - 1;
                    document.getElementById('modal-img').src = modalImages[modalIndex];
                    _updateModalImageCounter();
                    refreshImageInfoIfVisible();
                }
                refreshGalleryFromModal();
            }
        });
    };

    function refreshGallery() {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        var sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
        var sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
        var filters = (typeof window.getFilterState === 'function') ? window.getFilterState() : {};
        var url = '/gallery?path=' + encodeURIComponent(path) + '&search=&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1' +
            '&filter_filename=' + encodeURIComponent(filters.filter_filename || '') +
            '&filter_size_min=' + encodeURIComponent(filters.filter_size_min || '') +
            '&filter_size_max=' + encodeURIComponent(filters.filter_size_max || '') +
            '&filter_date_from=' + encodeURIComponent(filters.filter_date_from || '') +
            '&filter_date_to=' + encodeURIComponent(filters.filter_date_to || '');
        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    function refreshSidebar() {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var pathInput = document.querySelector('[name=path]');
        if (pathInput) path = pathInput.value || path;
        fetch('/api/sidebar-folder-tree?path=' + encodeURIComponent(path))
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var el = document.getElementById('folder-tree');
                if (el) {
                    el.innerHTML = html;
                    if (typeof htmx !== 'undefined') htmx.process(el);
                }
            })
            .catch(function(err) { console.error('刷新侧栏失败:', err); });
    }

    // HTMX 加载新内容后，如果处于选择模式，需要更新新内容的复选框状态
    document.body.addEventListener('htmx:afterSettle', function(ev) {
        if (!isSelectMode()) return;
        if (ev.detail.target.id === 'gallery-container' || ev.detail.target.id === 'gallery-grid') {
            // 重新显示复选框
            document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.remove('hidden'); });
        }
    });
})();

// ---------- 筛选面板 ----------
(function() {
    // 当前筛选状态（从 gallery 片段中读取）
    var _filterState = {
        filter_filename: '',
        filter_size_min: '',
        filter_size_max: '',
        filter_date_from: '',
        filter_date_to: ''
    };

    function readFilterState() {
        var fn = document.getElementById('filter-filename-input');
        var sMin = document.getElementById('filter-size-min-input');
        var sMax = document.getElementById('filter-size-max-input');
        var dFrom = document.getElementById('filter-date-from-input');
        var dTo = document.getElementById('filter-date-to-input');
        return {
            filter_filename: fn ? fn.value.trim() : '',
            filter_size_min: sMin ? sMin.value : '',
            filter_size_max: sMax ? sMax.value : '',
            filter_date_from: dFrom ? dFrom.value : '',
            filter_date_to: dTo ? dTo.value : ''
        };
    }

    function triggerFilteredGallery(filters) {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        var sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
        var sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';

        var url = '/gallery?path=' + encodeURIComponent(path) +
            '&search=&mode=' + mode +
            '&sort_by=' + sortBy +
            '&sort_order=' + sortOrder +
            '&page=1' +
            '&filter_filename=' + encodeURIComponent(filters.filter_filename || '') +
            '&filter_size_min=' + encodeURIComponent(filters.filter_size_min || '') +
            '&filter_size_max=' + encodeURIComponent(filters.filter_size_max || '') +
            '&filter_date_from=' + encodeURIComponent(filters.filter_date_from || '') +
            '&filter_date_to=' + encodeURIComponent(filters.filter_date_to || '');

        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    function positionFilterPopover(btn, popover) {
        var rect = btn.getBoundingClientRect();
        var popW = 320; // w-80 = 20rem = 320px
        // 优先放在按钮下方、右对齐
        var top = rect.bottom + 8;
        var left = rect.right - popW;
        // 防止左侧溢出
        if (left < 8) left = 8;
        // 防止底部溢出：如果放不下就放到按钮上方
        var popH = popover.scrollHeight || 340;
        if (top + popH > window.innerHeight - 8) {
            top = rect.top - popH - 8;
            if (top < 8) top = 8;
        }
        popover.style.top = top + 'px';
        popover.style.left = left + 'px';
    }

    // 事件委托：点击筛选按钮打开/关闭面板
    document.body.addEventListener('click', function(e) {
        var filterBtn = e.target.closest('#filter-btn');
        var filterPopover = document.getElementById('filter-popover');
        var insidePopover = filterPopover && filterPopover.contains(e.target);

        if (filterBtn) {
            if (filterPopover) {
                filterPopover.classList.toggle('hidden');
                if (!filterPopover.classList.contains('hidden')) {
                    positionFilterPopover(filterBtn, filterPopover);
                }
            }
            return;
        }

        // 点击应用筛选
        if (e.target.closest('#filter-apply-btn')) {
            var filters = readFilterState();
            _filterState = filters;
            if (filterPopover) filterPopover.classList.add('hidden');
            triggerFilteredGallery(filters);
            return;
        }

        // 点击清除全部
        if (e.target.closest('#filter-clear-btn')) {
            // 重置所有输入
            var fn = document.getElementById('filter-filename-input');
            var sMin = document.getElementById('filter-size-min-input');
            var sMax = document.getElementById('filter-size-max-input');
            var dFrom = document.getElementById('filter-date-from-input');
            var dTo = document.getElementById('filter-date-to-input');
            if (fn) fn.value = '';
            if (sMin) sMin.value = '';
            if (sMax) sMax.value = '';
            if (dFrom) dFrom.value = '';
            if (dTo) dTo.value = '';
            _filterState = {filter_filename: '', filter_size_min: '', filter_size_max: '', filter_date_from: '', filter_date_to: ''};
            if (filterPopover) filterPopover.classList.add('hidden');
            triggerFilteredGallery(_filterState);
            return;
        }

        // 点击外部关闭面板
        if (filterPopover && !filterPopover.classList.contains('hidden') && !insidePopover) {
            filterPopover.classList.add('hidden');
        }
    });

    // 回车键应用筛选
    document.body.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            var filterPopover = document.getElementById('filter-popover');
            if (filterPopover && !filterPopover.classList.contains('hidden')) {
                var isInsideFilter = e.target.closest('#filter-popover');
                if (isInsideFilter) {
                    e.preventDefault();
                    var filters = readFilterState();
                    _filterState = filters;
                    filterPopover.classList.add('hidden');
                    triggerFilteredGallery(filters);
                }
            }
        }
    });

    // 暴露过滤状态到全局（其他逻辑可能需要）
    window.getFilterState = function() { return _filterState; };
})();

// ---------- 顶部目录搜索 ----------
(function() {
    var searchInput = document.getElementById('dir-search-input');
    var dropdown = document.getElementById('dir-search-dropdown');
    var timer = null;

    function doSearch(query) {
        if (!query.trim()) {
            dropdown.classList.add('hidden');
            dropdown.innerHTML = '';
            return;
        }
        fetch('/api/search-dirs?q=' + encodeURIComponent(query) + '&limit=20')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.dirs || data.dirs.length === 0) {
                    dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400">未找到匹配的文件夹</div>';
                    dropdown.classList.remove('hidden');
                    return;
                }
                var html = '';
                for (var i = 0; i < data.dirs.length; i++) {
                    var d = data.dirs[i];
                    // 高亮匹配部分
                    var displayPath = highlightMatch(d.path, query);
                    html += '<button type="button" class="dir-search-item w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-slate-50 last:border-0" data-path="' + escapeAttr(d.path) + '">' +
                        '<svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>' +
                        '<span class="text-sm text-slate-700 truncate flex-1">' + displayPath + '</span>' +
                        '<span class="text-xs text-slate-400 flex-shrink-0">' + d.image_count + ' 张</span>' +
                    '</button>';
                }
                dropdown.innerHTML = html;
                dropdown.classList.remove('hidden');
            })
            .catch(function() {
                dropdown.classList.add('hidden');
            });
    }

    function highlightMatch(path, query) {
        var ql = query.toLowerCase();
        var pl = path.toLowerCase();
        var idx = pl.indexOf(ql);
        if (idx === -1) return escapeHtml(path);
        return escapeHtml(path.substring(0, idx)) +
            '<span class="text-blue-600 font-medium">' + escapeHtml(path.substring(idx, idx + query.length)) + '</span>' +
            escapeHtml(path.substring(idx + query.length));
    }

    function escapeHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function escapeAttr(s) {
        return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function navigateToDir(dirPath) {
        dropdown.classList.add('hidden');
        searchInput.value = '';
        // 更新隐藏的 path input
        document.querySelector('[name=path]').value = dirPath;
        // 通过 HTMX 加载该目录的 gallery
        var mode = document.getElementById('mode-input') ? document.getElementById('mode-input').value : 'folder';
        var sortBy = document.getElementById('sort-by-input') ? document.getElementById('sort-by-input').value : 'modified_at';
        var sortOrder = document.getElementById('sort-order-input') ? document.getElementById('sort-order-input').value : 'desc';
        var url = '/gallery?path=' + encodeURIComponent(dirPath) + '&search=&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1';
        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(timer);
            var val = this.value;
            timer = setTimeout(function() { doSearch(val); }, 250);
        });

        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                this.blur();
            }
            if (e.key === 'Enter') {
                // 选中第一个结果
                var first = dropdown.querySelector('.dir-search-item');
                if (first) {
                    navigateToDir(first.getAttribute('data-path'));
                }
            }
            // 上下键导航
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                var items = dropdown.querySelectorAll('.dir-search-item');
                if (items.length === 0) return;
                var active = dropdown.querySelector('.dir-search-item.bg-blue-50');
                var idx = -1;
                for (var i = 0; i < items.length; i++) {
                    if (items[i] === active) { idx = i; break; }
                }
                // 移除当前高亮
                if (active) active.classList.remove('bg-blue-50');
                if (e.key === 'ArrowDown') idx = (idx + 1) % items.length;
                else idx = idx <= 0 ? items.length - 1 : idx - 1;
                items[idx].classList.add('bg-blue-50');
                items[idx].scrollIntoView({block: 'nearest'});
            }
        });

        // 处理 Enter 键选中高亮项
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                var active = dropdown.querySelector('.dir-search-item.bg-blue-50');
                if (active) {
                    e.preventDefault();
                    navigateToDir(active.getAttribute('data-path'));
                }
            }
        });
    }

    // 点击下拉结果
    if (dropdown) {
        dropdown.addEventListener('click', function(e) {
            var item = e.target.closest('.dir-search-item');
            if (item) {
                navigateToDir(item.getAttribute('data-path'));
            }
        });
    }

    // 点击外部关闭下拉
    document.addEventListener('click', function(e) {
        var wrapper = document.getElementById('dir-search-wrapper');
        if (wrapper && !wrapper.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
})();

// HTMX 交换后更新侧栏选中状态、mode 输入、并确保缩略图大小应用
document.body.addEventListener('htmx:afterSwap', function(ev) {
    if (ev.detail.target.id === 'gallery-container') {
        // 将面包屑+操作按钮移到顶栏第一行
        var topBar = ev.detail.target.querySelector('.gallery-top-bar');
        var slot = document.getElementById('gallery-top-slot');
        if (topBar && slot) {
            slot.innerHTML = '';
            slot.appendChild(topBar);
        }

        const saved = localStorage.getItem('fastpic_gallery_cols');
        const sc = document.getElementById('scroll-container');
        if (sc && saved) sc.style.setProperty('--gallery-cols', saved);
        const marker = document.getElementById('current-path-marker');
        const path = marker ? (marker.getAttribute('data-path') || '') : '';
        const mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        const sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
        const sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
        const modeInput = document.getElementById('mode-input');
        if (modeInput) modeInput.value = mode;
        const sortByInput = document.getElementById('sort-by-input');
        if (sortByInput) sortByInput.value = sortBy;
        const sortOrderInput = document.getElementById('sort-order-input');
        if (sortOrderInput) sortOrderInput.value = sortOrder;
        document.querySelectorAll('#sidebar .folder-link').forEach(function(link) {
            const isCurrent = link.getAttribute('data-path') === path;
            link.classList.toggle('bg-blue-50', isCurrent);
            link.classList.toggle('text-blue-600', isCurrent);
            link.classList.toggle('hover:bg-slate-100', !isCurrent);
        });

        // 同步筛选状态到全局
        if (marker && typeof window.getFilterState === 'function') {
            var filterState = window.getFilterState();
            // 从 marker 读取实际应用的筛选条件，更新全局状态
            filterState.filter_filename = marker.getAttribute('data-filter-filename') || '';
            filterState.filter_size_min = marker.getAttribute('data-filter-size-min') || '';
            filterState.filter_size_max = marker.getAttribute('data-filter-size-max') || '';
            filterState.filter_date_from = marker.getAttribute('data-filter-date-from') || '';
            filterState.filter_date_to = marker.getAttribute('data-filter-date-to') || '';
        }
    }
});
</script>
{% endblock %}
