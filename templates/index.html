{% extends "base.html" %}
{% block content %}
<div class="flex h-screen" id="layout">
    <!-- 左侧文件夹树（可调节宽度，默认隐藏） -->
    <aside id="sidebar" class="bg-white border-r border-slate-200 flex-shrink-0 overflow-y-auto hidden" style="width: var(--sidebar-width, 220px); min-width: 160px; max-width: 800px;">
        <div class="p-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold text-slate-800">全部文件夹</h2>
                <button type="button" class="p-1 rounded hover:bg-slate-100 text-slate-500" aria-label="隐藏文件夹树" title="隐藏文件夹树" onclick="toggleSidebar()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
                </button>
            </div>
            <div class="space-y-0" id="folder-tree">
                {% set is_root = (request.query_params.get('path') or '') == '' %}
                <a href="/" data-path="" class="folder-link block px-3 py-2 rounded transition-colors {{ 'bg-blue-50 text-blue-600' if is_root else 'hover:bg-slate-100 text-slate-700' }}"
                   hx-get="/gallery?path=&search=&page=1"
                   hx-target="#gallery-container"
                   hx-swap="innerHTML"
                   hx-include="#mode-input, #sort-by-input, #sort-order-input"
                   hx-on:click="document.querySelector('[name=path]').value = ''">/ 全部</a>
                {% macro render_folder(prefix, children, depth) %}
                {% for part, sub in children.items() %}
                {% set path_parts = prefix + [part] %}
                {% set path_str = path_parts|join('/') %}
                {% set is_current = path_str == (request.query_params.get('path') or '') %}
                <div class="folder-node" data-path="{{ path_str }}">
                    <div class="flex items-center group" style="padding-left: {{ 12 + depth * 16 }}px;">
                        {% if sub %}
                        <button type="button" class="folder-toggle w-5 h-5 flex-shrink-0 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 group-hover:text-slate-700 transition-colors"
                                data-expanded="false"
                                onclick="toggleFolder(this); event.stopPropagation();"
                                aria-label="展开">
                            <svg class="chevron w-3 h-3 transition-transform" viewBox="0 0 12 12" fill="currentColor"><path d="M4 2L8 6 4 10"/></svg>
                        </button>
                        {% else %}
                        <span class="w-5 flex-shrink-0"></span>
                        {% endif %}
                        <a href="?path={{ path_str|urlencode_path }}"
                           data-path="{{ path_str }}"
                           class="folder-link flex-1 min-w-0 px-2 py-1.5 rounded truncate transition-colors {{ 'bg-blue-50 text-blue-600' if is_current else 'hover:bg-slate-100 text-slate-700' }}"
                           hx-get="/gallery?path={{ path_str|urlencode_path }}&search=&page=1"
                           hx-target="#gallery-container"
                           hx-swap="innerHTML"
                           hx-include="#mode-input, #sort-by-input, #sort-order-input"
                           hx-on:click="document.querySelector('[name=path]').value = '{{ path_str }}'">
                            {{ part }}
                        </a>
                    </div>
                    {% if sub %}
                    <div class="folder-children hidden">
                        {{ render_folder(path_parts, sub, depth + 1) }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% endmacro %}
                {{ render_folder([], nested_tree, 0) }}
            </div>
        </div>
    </aside>

    <!-- 拖拽调节手柄（默认隐藏，跟随侧栏） -->
    <div id="resize-handle"
         class="flex-shrink-0 w-1.5 cursor-col-resize hover:bg-blue-100 transition-colors flex items-center justify-center group bg-slate-100 hidden"
         role="separator"
         aria-label="调节侧边栏宽度">
        <div class="w-0.5 h-8 bg-slate-400 group-hover:bg-blue-500 rounded-full opacity-60 group-hover:opacity-100 transition-opacity"></div>
    </div>

    <!-- 右侧主区 -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-50">
        <!-- 顶部栏：搜索 + AI 搜索 + 图标 -->
        <header class="p-4 bg-white border-b border-slate-200 flex-shrink-0">
            <div class="flex items-center gap-3">
                <!-- 侧边栏切换按钮 -->
                <button type="button" id="sidebar-toggle-btn"
                        class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors flex-shrink-0"
                        title="显示/隐藏文件夹树"
                        onclick="toggleSidebar()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                </button>
                <div class="flex-1 flex items-center gap-2 pl-3 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500">
                    <svg class="w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="hidden" name="path" id="path-input" value="{{ request.query_params.get('path', '') or '' }}">
                    <input type="hidden" name="mode" id="mode-input" value="{{ request.query_params.get('mode', 'folder') }}">
                    <input type="search"
                           name="search"
                           placeholder="输入一段描述搜索照片: 在公园散步"
                           class="flex-1 min-w-0 bg-transparent border-none focus:outline-none focus:ring-0 text-slate-800 placeholder-slate-400"
                           hx-get="/gallery"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#gallery-container"
                           hx-include="#path-input, #mode-input, #sort-by-input, #sort-order-input"
                           hx-vals='{"page": 1}'
                           hx-swap="innerHTML">
                </div>
                <button type="button" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors">AI 搜索</button>
                <div class="flex items-center gap-1">
                    <button type="button" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors" title="添加"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg></button>
                    <button type="button" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors" title="上传"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg></button>
                    <button type="button" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700 transition-colors" title="设置"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                </div>
            </div>
        </header>

        <!-- 图片网格 -->
        <div class="flex-1 overflow-y-auto p-4" id="scroll-container">
            <div id="gallery-container"
                 hx-get="/gallery?path={{ (request.query_params.get('path') or '')|urlencode_path }}&search=&mode={{ request.query_params.get('mode', 'folder') }}&sort_by={{ request.query_params.get('sort_by', 'modified_at') }}&sort_order={{ request.query_params.get('sort_order', 'desc') }}&page=1"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="flex justify-center items-center h-64 text-slate-500">
                    <span class="htmx-indicator">加载中...</span>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- 大图预览模态框 -->
<div id="modal" class="fixed inset-0 z-50 hidden" onclick="closeModal(event)">
    <div id="modal-overlay" class="absolute inset-0 bg-black/80 flex items-center justify-center">
        <!-- 顶部工具栏 -->
        <div class="absolute top-0 left-0 right-0 flex items-center justify-between p-4 z-10" onclick="event.stopPropagation()">
            <!-- 左侧：幻灯片控件 -->
            <div class="flex items-center gap-2">
                <button type="button" id="slideshow-btn" onclick="toggleSlideshow(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="幻灯片播放">
                    <!-- 播放图标 -->
                    <svg id="slideshow-play-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <!-- 暂停图标 -->
                    <svg id="slideshow-pause-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
                <!-- 间隔设置 -->
                <div class="relative" id="slideshow-interval-wrapper">
                    <button type="button" id="slideshow-interval-btn" onclick="toggleSlideshowInterval(); event.stopPropagation();"
                            class="px-2.5 py-1.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white text-xs font-medium transition-all"
                            title="播放间隔">
                        <span id="slideshow-interval-label">2s</span>
                    </button>
                    <div id="slideshow-interval-popover" class="hidden absolute left-0 top-full mt-2 p-3 bg-slate-800/95 backdrop-blur rounded-lg shadow-xl border border-white/10 min-w-[180px]">
                        <div class="text-xs text-white/60 mb-2">播放间隔</div>
                        <input type="range" id="slideshow-interval-slider" min="1" max="10" step="0.5" value="2"
                               class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-blue-400"
                               oninput="updateSlideshowInterval(this.value)">
                        <div class="flex justify-between text-xs text-white/50 mt-1">
                            <span>1s</span>
                            <span id="slideshow-interval-value">2 秒</span>
                            <span>10s</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右侧：删除 + 关闭 -->
            <div class="flex items-center gap-2">
                <button type="button" id="modal-delete-btn" onclick="deleteCurrentImage(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-red-500/80 text-white/80 hover:text-white transition-all"
                        title="删除当前图片">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
                <button type="button" onclick="closeModalAndStopSlideshow(); event.stopPropagation();"
                        class="p-2.5 rounded-full bg-white/15 hover:bg-white/30 text-white/80 hover:text-white transition-all"
                        title="关闭">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>
        <button type="button" onclick="prevImage(); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/20 hover:bg-white/40 text-white text-2xl flex items-center justify-center">‹</button>
        <img id="modal-img" src="" alt="" class="max-w-[90vw] max-h-[90vh] object-contain" onclick="event.stopPropagation()">
        <button type="button" onclick="nextImage(); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/20 hover:bg-white/40 text-white text-2xl flex items-center justify-center">›</button>
    </div>
</div>

<script>
// 侧边栏开关（默认隐藏，localStorage 持久化）
(function() {
    const SIDEBAR_VISIBLE_KEY = 'fastpic_sidebar_visible';

    function isSidebarVisible() {
        return localStorage.getItem(SIDEBAR_VISIBLE_KEY) === 'true';
    }

    function applySidebarState(visible) {
        const sidebar = document.getElementById('sidebar');
        const handle = document.getElementById('resize-handle');
        const btn = document.getElementById('sidebar-toggle-btn');
        if (visible) {
            sidebar.classList.remove('hidden');
            handle.classList.remove('hidden');
            btn.classList.add('bg-blue-50', 'text-blue-600');
            btn.classList.remove('text-slate-500');
        } else {
            sidebar.classList.add('hidden');
            handle.classList.add('hidden');
            btn.classList.remove('bg-blue-50', 'text-blue-600');
            btn.classList.add('text-slate-500');
        }
    }

    // 页面加载时恢复状态
    applySidebarState(isSidebarVisible());

    // 全局切换函数
    window.toggleSidebar = function() {
        const visible = !isSidebarVisible();
        localStorage.setItem(SIDEBAR_VISIBLE_KEY, String(visible));
        applySidebarState(visible);
    };
})();

function toggleFolder(btn) {
    const node = btn.closest('.folder-node');
    const children = node.querySelector(':scope > .folder-children');
    if (!children) return;
    const expanded = btn.getAttribute('data-expanded') === 'true';
        if (expanded) {
            children.classList.add('hidden');
            btn.querySelector('.chevron').classList.remove('-rotate-90');
            btn.setAttribute('data-expanded', 'false');
            btn.setAttribute('aria-label', '展开');
        } else {
            children.classList.remove('hidden');
            btn.querySelector('.chevron').classList.add('-rotate-90');
            btn.setAttribute('data-expanded', 'true');
            btn.setAttribute('aria-label', '折叠');
        }
}

let modalImages = [];
let modalImageIds = [];
let modalIndex = 0;
let slideshowTimer = null;
let slideshowInterval = parseFloat(localStorage.getItem('fastpic_slideshow_interval') || '2');

function openModal(photoUrl, index, allUrls, allIds) {
    modalImages = allUrls;
    modalImageIds = allIds || [];
    modalIndex = index;
    document.getElementById('modal-img').src = photoUrl;
    document.getElementById('modal').classList.remove('hidden');
    // 同步间隔显示
    _updateIntervalUI(slideshowInterval);
}

function closeModal(e) {
    if (e.target.id === 'modal' || e.target.id === 'modal-overlay') {
        stopSlideshow();
        document.getElementById('modal').classList.add('hidden');
    }
}

function closeModalAndStopSlideshow() {
    stopSlideshow();
    document.getElementById('modal').classList.add('hidden');
}

function prevImage() {
    if (modalImages.length === 0) return;
    modalIndex = (modalIndex - 1 + modalImages.length) % modalImages.length;
    document.getElementById('modal-img').src = modalImages[modalIndex];
}

function nextImage() {
    if (modalImages.length === 0) return;
    modalIndex = (modalIndex + 1) % modalImages.length;
    document.getElementById('modal-img').src = modalImages[modalIndex];
}

// ── 幻灯片播放 ──

function toggleSlideshow() {
    if (slideshowTimer) {
        stopSlideshow();
    } else {
        startSlideshow();
    }
}

function startSlideshow() {
    if (modalImages.length <= 1) return;
    if (slideshowTimer) return;
    slideshowTimer = setInterval(function() {
        nextImage();
    }, slideshowInterval * 1000);
    // 更新按钮外观
    var playIcon = document.getElementById('slideshow-play-icon');
    var pauseIcon = document.getElementById('slideshow-pause-icon');
    var btn = document.getElementById('slideshow-btn');
    if (playIcon) playIcon.classList.add('hidden');
    if (pauseIcon) pauseIcon.classList.remove('hidden');
    if (btn) { btn.classList.add('bg-blue-500/60'); btn.classList.remove('bg-white/15'); }
}

function stopSlideshow() {
    if (slideshowTimer) {
        clearInterval(slideshowTimer);
        slideshowTimer = null;
    }
    var playIcon = document.getElementById('slideshow-play-icon');
    var pauseIcon = document.getElementById('slideshow-pause-icon');
    var btn = document.getElementById('slideshow-btn');
    if (playIcon) playIcon.classList.remove('hidden');
    if (pauseIcon) pauseIcon.classList.add('hidden');
    if (btn) { btn.classList.remove('bg-blue-500/60'); btn.classList.add('bg-white/15'); }
}

function toggleSlideshowInterval() {
    var popover = document.getElementById('slideshow-interval-popover');
    if (popover) popover.classList.toggle('hidden');
}

function updateSlideshowInterval(val) {
    slideshowInterval = parseFloat(val);
    localStorage.setItem('fastpic_slideshow_interval', String(slideshowInterval));
    _updateIntervalUI(slideshowInterval);
    // 如果正在播放，重启计时器以使用新间隔
    if (slideshowTimer) {
        stopSlideshow();
        startSlideshow();
    }
}

function _updateIntervalUI(val) {
    var label = document.getElementById('slideshow-interval-label');
    var valueText = document.getElementById('slideshow-interval-value');
    var slider = document.getElementById('slideshow-interval-slider');
    var display = val % 1 === 0 ? val + ' 秒' : val.toFixed(1) + ' 秒';
    if (label) label.textContent = val % 1 === 0 ? val + 's' : val.toFixed(1) + 's';
    if (valueText) valueText.textContent = display;
    if (slider) slider.value = val;
}

// 点击模态框外部区域关闭间隔弹窗
document.addEventListener('click', function(e) {
    var popover = document.getElementById('slideshow-interval-popover');
    var wrapper = document.getElementById('slideshow-interval-wrapper');
    if (popover && !popover.classList.contains('hidden') && wrapper && !wrapper.contains(e.target)) {
        popover.classList.add('hidden');
    }
});

function deleteCurrentImage() {
    if (modalImages.length === 0 || modalImageIds.length === 0) return;
    var imageId = modalImageIds[modalIndex];
    if (!imageId) return;

    // 简单确认
    if (!confirm('确定要删除这张图片吗？此操作不可恢复。')) return;

    var btn = document.getElementById('modal-delete-btn');
    if (btn) btn.disabled = true;

    fetch('/api/delete-images', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: [imageId]})
    }).then(function(r) { return r.json(); }).then(function(data) {
        // 从列表中移除当前图片
        modalImages.splice(modalIndex, 1);
        modalImageIds.splice(modalIndex, 1);

        if (modalImages.length === 0) {
            // 没有图片了，关闭模态框并刷新画廊
            document.getElementById('modal').classList.add('hidden');
            refreshGalleryFromModal();
        } else {
            // 调整索引，显示下一张（或最后一张）
            if (modalIndex >= modalImages.length) {
                modalIndex = modalImages.length - 1;
            }
            document.getElementById('modal-img').src = modalImages[modalIndex];
            // 刷新画廊（后台更新网格）
            refreshGalleryFromModal();
        }
        if (btn) btn.disabled = false;
    }).catch(function(err) {
        console.error('删除失败:', err);
        alert('删除失败');
        if (btn) btn.disabled = false;
    });
}

function refreshGalleryFromModal() {
    var marker = document.getElementById('current-path-marker');
    var path = marker ? (marker.getAttribute('data-path') || '') : '';
    var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
    var sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
    var sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
    var searchInput = document.querySelector('input[name="search"]');
    var search = searchInput ? searchInput.value : '';
    var url = '/gallery?path=' + encodeURIComponent(path) + '&search=' + encodeURIComponent(search) + '&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1';
    htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('modal');
    if (modal.classList.contains('hidden')) return;
    if (e.key === 'Escape') { stopSlideshow(); modal.classList.add('hidden'); }
    if (e.key === 'ArrowLeft') { stopSlideshow(); prevImage(); }
    if (e.key === 'ArrowRight') { stopSlideshow(); nextImage(); }
    if (e.key === 'Delete' || e.key === 'Backspace') { deleteCurrentImage(); }
    if (e.key === ' ') { e.preventDefault(); toggleSlideshow(); }
});

// 缩略图大小调节
(function() {
    const STORAGE_KEY = 'fastpic_gallery_cols';
    const DEFAULT_COLS = 4;
    const MIN_COLS = 2;
    const MAX_COLS = 8;

    function getScrollContainer() {
        return document.getElementById('scroll-container');
    }

    function initThumbnailSize() {
        const saved = localStorage.getItem(STORAGE_KEY);
        const cols = saved ? Math.max(MIN_COLS, Math.min(MAX_COLS, parseInt(saved, 10))) : DEFAULT_COLS;
        const sc = getScrollContainer();
        if (sc) sc.style.setProperty('--gallery-cols', String(cols));
    }

    function setThumbnailCols(cols) {
        const c = Math.max(MIN_COLS, Math.min(MAX_COLS, cols));
        const sc = getScrollContainer();
        if (sc) sc.style.setProperty('--gallery-cols', String(c));
        localStorage.setItem(STORAGE_KEY, String(c));
        const valEl = document.getElementById('thumbnail-size-value');
        if (valEl) valEl.textContent = c + ' 列';
        const slider = document.getElementById('thumbnail-size-slider');
        if (slider) slider.value = c;
        // 瀑布流模式下重建列布局
        if (typeof window.rebuildWaterfall === 'function') window.rebuildWaterfall();
    }

    initThumbnailSize();

    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('#thumbnail-size-btn');
        const popover = document.getElementById('thumbnail-size-popover');
        const insidePopover = popover && popover.contains(e.target);
        if (btn) {
            popover.classList.toggle('hidden');
            if (!popover.classList.contains('hidden')) {
                const slider = document.getElementById('thumbnail-size-slider');
                const saved = localStorage.getItem(STORAGE_KEY);
                const cols = saved ? parseInt(saved, 10) : DEFAULT_COLS;
                if (slider) slider.value = Math.max(MIN_COLS, Math.min(MAX_COLS, cols));
                setThumbnailCols(cols);
            }
        } else if (popover && !popover.classList.contains('hidden') && !insidePopover) {
            popover.classList.add('hidden');
        }
    });

    document.body.addEventListener('input', function(e) {
        if (e.target.id === 'thumbnail-size-slider') {
            setThumbnailCols(parseInt(e.target.value, 10));
        }
    });
})();

// 侧边栏宽度调节
(function() {
    const SIDEBAR_MIN = 160;
    const SIDEBAR_MAX = 800;
    const STORAGE_KEY = 'fastpic_sidebar_width';

    function initSidebarWidth() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const w = parseInt(saved, 10);
            if (w >= SIDEBAR_MIN && w <= SIDEBAR_MAX) {
                document.documentElement.style.setProperty('--sidebar-width', w + 'px');
            }
        }
    }

    function setSidebarWidth(px) {
        const w = Math.max(SIDEBAR_MIN, Math.min(SIDEBAR_MAX, px));
        document.documentElement.style.setProperty('--sidebar-width', w + 'px');
        localStorage.setItem(STORAGE_KEY, String(w));
    }

    initSidebarWidth();

    const handle = document.getElementById('resize-handle');
    const sidebar = document.getElementById('sidebar');

    handle.addEventListener('mousedown', function(e) {
        if (e.button !== 0) return;
        e.preventDefault();
        const startX = e.clientX;
        const startWidth = sidebar.getBoundingClientRect().width;

        function onMouseMove(e) {
            const dx = e.clientX - startX;
            setSidebarWidth(startWidth + dx);
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
})();

// 瀑布流布局管理器（JS 多列，避免 CSS columns 重排）
(function() {
    var wfColumns = [];
    var wfHeights = [];
    var wfInitialized = false;

    function getColCount() {
        var saved = localStorage.getItem('fastpic_gallery_cols');
        return saved ? Math.max(2, Math.min(8, parseInt(saved, 10))) : 4;
    }

    function isWaterfallMode() {
        var marker = document.getElementById('current-path-marker');
        return marker && marker.getAttribute('data-mode') === 'waterfall';
    }

    function getShortestCol() {
        var minIdx = 0;
        for (var i = 1; i < wfHeights.length; i++) {
            if (wfHeights[i] < wfHeights[minIdx]) minIdx = i;
        }
        return minIdx;
    }

    function getItemHeight(item) {
        var w = parseInt(item.getAttribute('data-w')) || 0;
        var h = parseInt(item.getAttribute('data-h')) || 0;
        if (w > 0 && h > 0) return (h / w) * 1000;
        return 1000;
    }

    function placeItem(item) {
        var idx = getShortestCol();
        wfColumns[idx].appendChild(item);
        wfHeights[idx] += getItemHeight(item);
    }

    function initWaterfall() {
        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var colCount = getColCount();

        // 收集所有直接子元素（图片卡片 + 滚动哨兵）
        var items = [];
        var sentinel = null;
        Array.from(grid.children).forEach(function(child) {
            if (child.classList && child.classList.contains('selectable-item')) {
                items.push(child);
            } else if (child.tagName === 'A') {
                items.push(child);
            } else if (child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinel = child;
            }
        });

        // 移除旧元素
        items.forEach(function(item) { item.remove(); });
        if (sentinel) sentinel.remove();

        // 移除可能存在的旧 wf-row
        var oldRow = document.getElementById('wf-row');
        if (oldRow) oldRow.remove();

        // 创建列容器
        var row = document.createElement('div');
        row.id = 'wf-row';
        grid.appendChild(row);

        wfColumns = [];
        wfHeights = new Array(colCount).fill(0);
        for (var i = 0; i < colCount; i++) {
            var col = document.createElement('div');
            col.className = 'wf-col';
            row.appendChild(col);
            wfColumns.push(col);
        }

        // 按最短列分配图片
        items.forEach(function(item) { placeItem(item); });

        // 哨兵放在 grid 最后（在列容器下方，确保滚动到底部才触发）
        if (sentinel) grid.appendChild(sentinel);

        wfInitialized = true;
    }

    function distributeNew() {
        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var wfRow = document.getElementById('wf-row');
        if (!wfRow) return;

        // 找到所有不在 wf-row 中的直接子元素（HTMX 追加的新内容）
        var newImages = [];
        var sentinels = [];
        Array.from(grid.children).forEach(function(child) {
            if (child === wfRow) return;
            if (child.classList && child.classList.contains('selectable-item')) {
                newImages.push(child);
            } else if (child.tagName === 'A') {
                newImages.push(child);
            } else if (child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinels.push(child);
            }
        });

        // 将新图片分配到最短列
        newImages.forEach(function(item) {
            item.remove();
            placeItem(item);
        });

        // 只保留最新的哨兵，移除旧的
        if (sentinels.length > 1) {
            sentinels.slice(0, -1).forEach(function(s) { s.remove(); });
        }
    }

    function rebuildWaterfall() {
        if (!isWaterfallMode() || !wfInitialized) return;

        var grid = document.getElementById('gallery-grid');
        if (!grid) return;

        var wfRow = document.getElementById('wf-row');
        if (!wfRow) return;

        // 从各列中收集所有图片
        var items = [];
        wfColumns.forEach(function(col) {
            Array.from(col.children).forEach(function(child) {
                items.push(child);
            });
        });

        // 收集哨兵
        var sentinel = null;
        Array.from(grid.children).forEach(function(child) {
            if (child !== wfRow && child.hasAttribute('hx-get') && child.hasAttribute('hx-trigger')) {
                sentinel = child;
            }
        });

        // 清空
        wfRow.remove();
        if (sentinel) sentinel.remove();

        // 重新放回 grid
        items.forEach(function(item) { grid.appendChild(item); });
        if (sentinel) grid.appendChild(sentinel);

        // 重新初始化
        initWaterfall();
    }

    // 暴露给外部（缩略图大小改变时调用）
    window.rebuildWaterfall = rebuildWaterfall;

    // 监听 HTMX 交换事件
    document.body.addEventListener('htmx:afterSettle', function(ev) {
        if (ev.detail.target.id === 'gallery-container') {
            // 全量加载（首页 / 切换模式 / 切换文件夹）
            wfInitialized = false;
            wfColumns = [];
            wfHeights = [];
            if (isWaterfallMode()) {
                initWaterfall();
            }
        } else if (ev.detail.target.id === 'gallery-grid' && wfInitialized && isWaterfallMode()) {
            // 追加加载（无限滚动）
            distributeNew();
        }
    });
})();

// 排序下拉菜单
(function() {
    function getCurrentSort() {
        var sortByInput = document.getElementById('sort-by-input');
        var sortOrderInput = document.getElementById('sort-order-input');
        return {
            sort_by: sortByInput ? sortByInput.value : 'modified_at',
            sort_order: sortOrderInput ? sortOrderInput.value : 'desc'
        };
    }

    function triggerSort(sortBy, sortOrder) {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        var searchInput = document.querySelector('input[name="search"]');
        var search = searchInput ? searchInput.value : '';
        var sortByInput = document.getElementById('sort-by-input');
        var sortOrderInput = document.getElementById('sort-order-input');
        if (sortByInput) sortByInput.value = sortBy;
        if (sortOrderInput) sortOrderInput.value = sortOrder;

        var encodedPath = encodeURIComponent(path);
        var encodedSearch = encodeURIComponent(search);
        var url = '/gallery?path=' + encodedPath + '&search=' + encodedSearch + '&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1';

        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('#sort-btn');
        var popover = document.getElementById('sort-popover');
        var insidePopover = popover && popover.contains(e.target);

        // 点击排序字段选项
        var fieldOption = e.target.closest('.sort-field-option');
        if (fieldOption && popover && popover.contains(fieldOption)) {
            var current = getCurrentSort();
            triggerSort(fieldOption.getAttribute('data-sort-field'), current.sort_order);
            popover.classList.add('hidden');
            return;
        }

        // 点击排序顺序选项
        var orderOption = e.target.closest('.sort-order-option');
        if (orderOption && popover && popover.contains(orderOption)) {
            var current = getCurrentSort();
            triggerSort(current.sort_by, orderOption.getAttribute('data-sort-order'));
            popover.classList.add('hidden');
            return;
        }

        // 切换排序弹出框
        if (btn) {
            if (popover) popover.classList.toggle('hidden');
        } else if (popover && !popover.classList.contains('hidden') && !insidePopover) {
            popover.classList.add('hidden');
        }
    });
})();

// ---------- 批量选择 & 删除 ----------
(function() {
    window._selectMode = false;
    var _selectedImages = new Set();  // image ids
    var _selectedFolders = new Set(); // folder paths

    function isSelectMode() { return window._selectMode; }

    function enterSelectMode() {
        window._selectMode = true;
        var btn = document.getElementById('select-mode-btn');
        if (btn) { btn.classList.add('bg-blue-100', 'text-blue-600'); btn.classList.remove('hover:bg-slate-100', 'hover:text-slate-700'); }
        var selAllBtn = document.getElementById('select-all-btn');
        if (selAllBtn) selAllBtn.classList.remove('hidden');
        // 显示所有复选框
        document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.remove('hidden'); });
    }

    function exitSelectMode() {
        window._selectMode = false;
        _selectedImages.clear();
        _selectedFolders.clear();
        var btn = document.getElementById('select-mode-btn');
        if (btn) { btn.classList.remove('bg-blue-100', 'text-blue-600'); btn.classList.add('hover:bg-slate-100', 'hover:text-slate-700'); }
        var selAllBtn = document.getElementById('select-all-btn');
        if (selAllBtn) selAllBtn.classList.add('hidden');
        var delBtn = document.getElementById('delete-selected-btn');
        if (delBtn) delBtn.classList.add('hidden');
        // 隐藏复选框，取消选中效果
        document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.add('hidden'); });
        document.querySelectorAll('.selectable-item').forEach(function(item) { uncheckItem(item); });
    }

    window.toggleSelectMode = function() {
        if (isSelectMode()) { exitSelectMode(); } else { enterSelectMode(); }
    };

    function checkItem(item) {
        item.setAttribute('data-selected', 'true');
        var overlay = item.querySelector('.select-overlay');
        if (overlay) overlay.classList.remove('hidden');
        var cbDiv = item.querySelector('.select-checkbox > div');
        if (cbDiv) { cbDiv.classList.add('bg-blue-500', 'border-blue-500'); cbDiv.classList.remove('bg-white/80'); }
        var icon = item.querySelector('.check-icon');
        if (icon) icon.classList.remove('hidden');
    }

    function uncheckItem(item) {
        item.removeAttribute('data-selected');
        var overlay = item.querySelector('.select-overlay');
        if (overlay) overlay.classList.add('hidden');
        var cbDiv = item.querySelector('.select-checkbox > div');
        if (cbDiv) { cbDiv.classList.remove('bg-blue-500', 'border-blue-500'); cbDiv.classList.add('bg-white/80'); }
        var icon = item.querySelector('.check-icon');
        if (icon) icon.classList.add('hidden');
    }

    function updateDeleteButton() {
        var total = _selectedImages.size + _selectedFolders.size;
        var delBtn = document.getElementById('delete-selected-btn');
        var countText = document.getElementById('delete-count-text');
        if (total > 0) {
            if (delBtn) delBtn.classList.remove('hidden');
            if (countText) countText.textContent = '删除 (' + total + ')';
        } else {
            if (delBtn) delBtn.classList.add('hidden');
        }
    }

    window.handleItemClick = function(event, item) {
        if (!isSelectMode()) {
            // 非选择模式：文件夹正常导航，图片正常预览
            return;
        }
        // 选择模式下阻止所有导航/链接
        event.preventDefault();
        event.stopPropagation();

        var type = item.getAttribute('data-type');
        var isSelected = item.getAttribute('data-selected') === 'true';

        if (isSelected) {
            uncheckItem(item);
            if (type === 'image') _selectedImages.delete(parseInt(item.getAttribute('data-image-id')));
            if (type === 'folder') _selectedFolders.delete(item.getAttribute('data-folder-path'));
        } else {
            checkItem(item);
            if (type === 'image') _selectedImages.add(parseInt(item.getAttribute('data-image-id')));
            if (type === 'folder') _selectedFolders.add(item.getAttribute('data-folder-path'));
        }
        updateDeleteButton();
    };

    window.toggleSelectAll = function() {
        var items = document.querySelectorAll('.selectable-item');
        // 判断是全选还是取消全选
        var allSelected = true;
        items.forEach(function(item) {
            if (item.getAttribute('data-selected') !== 'true') allSelected = false;
        });
        items.forEach(function(item) {
            var type = item.getAttribute('data-type');
            if (allSelected) {
                uncheckItem(item);
                if (type === 'image') _selectedImages.delete(parseInt(item.getAttribute('data-image-id')));
                if (type === 'folder') _selectedFolders.delete(item.getAttribute('data-folder-path'));
            } else {
                checkItem(item);
                if (type === 'image') _selectedImages.add(parseInt(item.getAttribute('data-image-id')));
                if (type === 'folder') _selectedFolders.add(item.getAttribute('data-folder-path'));
            }
        });
        updateDeleteButton();
    };

    window.confirmDeleteSelected = function() {
        var imgCount = _selectedImages.size;
        var folderCount = _selectedFolders.size;
        if (imgCount === 0 && folderCount === 0) return;

        var msg = '确定要删除以下内容吗？\n\n';
        if (folderCount > 0) msg += '• ' + folderCount + ' 个文件夹（包含其中所有图片）\n';
        if (imgCount > 0) msg += '• ' + imgCount + ' 张图片\n';
        msg += '\n此操作不可恢复！';

        // 显示自定义确认对话框
        showDeleteConfirmDialog(msg, function() {
            executeDelete(Array.from(_selectedImages), Array.from(_selectedFolders));
        });
    };

    function showDeleteConfirmDialog(message, onConfirm) {
        // 移除之前的对话框（如果有）
        var old = document.getElementById('delete-confirm-dialog');
        if (old) old.remove();

        var overlay = document.createElement('div');
        overlay.id = 'delete-confirm-dialog';
        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/40';
        overlay.innerHTML =
            '<div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">' +
                '<div class="flex items-center gap-3 mb-4">' +
                    '<div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">' +
                        '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' +
                    '</div>' +
                    '<h3 class="text-lg font-semibold text-slate-800">确认删除</h3>' +
                '</div>' +
                '<pre class="text-sm text-slate-600 mb-6 whitespace-pre-wrap font-sans">' + message.replace(/</g, '&lt;') + '</pre>' +
                '<div class="flex justify-end gap-3">' +
                    '<button type="button" class="cancel-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm font-medium transition-colors">取消</button>' +
                    '<button type="button" class="confirm-btn px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors">确认删除</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        overlay.querySelector('.cancel-btn').addEventListener('click', function() { overlay.remove(); });
        overlay.querySelector('.confirm-btn').addEventListener('click', function() {
            overlay.remove();
            onConfirm();
        });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
    }

    function executeDelete(imageIds, folderPaths) {
        var delBtn = document.getElementById('delete-selected-btn');
        if (delBtn) {
            delBtn.disabled = true;
            delBtn.querySelector('#delete-count-text').textContent = '删除中...';
        }

        var promises = [];

        if (imageIds.length > 0) {
            promises.push(
                fetch('/api/delete-images', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: imageIds})
                }).then(function(r) { return r.json(); })
            );
        }

        if (folderPaths.length > 0) {
            promises.push(
                fetch('/api/delete-folders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({paths: folderPaths})
                }).then(function(r) { return r.json(); })
            );
        }

        Promise.all(promises).then(function(results) {
            // 退出选择模式
            exitSelectMode();
            // 如果删除了文件夹，需要重新加载整个页面以更新侧栏文件夹树
            if (folderPaths.length > 0) {
                window.location.reload();
                return;
            }
            // 仅删除了图片，刷新画廊即可
            refreshGallery();
        }).catch(function(err) {
            console.error('删除失败:', err);
            alert('删除失败，请查看控制台日志');
            if (delBtn) {
                delBtn.disabled = false;
                updateDeleteButton();
            }
        });
    }

    function refreshGallery() {
        var marker = document.getElementById('current-path-marker');
        var path = marker ? (marker.getAttribute('data-path') || '') : '';
        var mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        var sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
        var sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
        var searchInput = document.querySelector('input[name="search"]');
        var search = searchInput ? searchInput.value : '';
        var url = '/gallery?path=' + encodeURIComponent(path) + '&search=' + encodeURIComponent(search) + '&mode=' + mode + '&sort_by=' + sortBy + '&sort_order=' + sortOrder + '&page=1';
        htmx.ajax('GET', url, {target: '#gallery-container', swap: 'innerHTML'});
    }

    // HTMX 加载新内容后，如果处于选择模式，需要更新新内容的复选框状态
    document.body.addEventListener('htmx:afterSettle', function(ev) {
        if (!isSelectMode()) return;
        if (ev.detail.target.id === 'gallery-container' || ev.detail.target.id === 'gallery-grid') {
            // 重新显示复选框
            document.querySelectorAll('.select-checkbox').forEach(function(cb) { cb.classList.remove('hidden'); });
        }
    });
})();

// HTMX 交换后更新侧栏选中状态、mode 输入、并确保缩略图大小应用
document.body.addEventListener('htmx:afterSwap', function(ev) {
    if (ev.detail.target.id === 'gallery-container') {
        const saved = localStorage.getItem('fastpic_gallery_cols');
        const sc = document.getElementById('scroll-container');
        if (sc && saved) sc.style.setProperty('--gallery-cols', saved);
        const marker = document.getElementById('current-path-marker');
        const path = marker ? (marker.getAttribute('data-path') || '') : '';
        const mode = marker ? (marker.getAttribute('data-mode') || 'folder') : 'folder';
        const sortBy = marker ? (marker.getAttribute('data-sort-by') || 'modified_at') : 'modified_at';
        const sortOrder = marker ? (marker.getAttribute('data-sort-order') || 'desc') : 'desc';
        const modeInput = document.getElementById('mode-input');
        if (modeInput) modeInput.value = mode;
        const sortByInput = document.getElementById('sort-by-input');
        if (sortByInput) sortByInput.value = sortBy;
        const sortOrderInput = document.getElementById('sort-order-input');
        if (sortOrderInput) sortOrderInput.value = sortOrder;
        document.querySelectorAll('#sidebar .folder-link').forEach(function(link) {
            const isCurrent = link.getAttribute('data-path') === path;
            link.classList.toggle('bg-blue-50', isCurrent);
            link.classList.toggle('text-blue-600', isCurrent);
            link.classList.toggle('hover:bg-slate-100', !isCurrent);
        });
    }
});
</script>
{% endblock %}
